###########################################
# solax_set_mode_and_settings Script
# v2.0.1 Consolidation of version number - no changes to this template.
# v1.7.0 Added return to 'do nothing' after discharge
# v1.6.2 Forgot a namespace
# v1.6.1 Deterministic verification using observed values + diagnostic logging
# v1.5.0 Deterministic verification using observed values + diagnostic logging
# v1.4.0 Added mode-specific setting filtering to skip irrelevant settings
# v1.3.6 fixed the timeout check being in the wrong format
# v1.3.5 Bug fix to prevent premature exit after 1 try if theres a failure setting settings or modes
# v1.3.4 Bug fix with success and needs_update logic
# v1.3.2 Bug fix relating to previous bug where I didn't properly add the ns in the used output
# v1.3.1 Fixed bug in for loops (forgot to add a namespace so, the answer wasn't really being checked after we force update of settings)
# v1.3.0 Added constants dictionary for persistent timing/config values
# v1.1.0 Improved testing of solax_local_settings in the event of failed api calls
# v1.0.0 Initial
###########################################
#   constants:
#     max_loops
#     max_settings_retries
#     refresh_delay - this MUST be greater than the rest timeout in solax_rest_local_settings
#     settings_delay - gap between each setting being applied
#     timeout_seconds - Time out for the whole script
#     mode_delays - give the inverter time to switch between modes
solax_set_mode_and_settings:
  trace:
    stored_traces: 20
  alias: "Solax Set Mode and Settings"
  description: >
    Sets Solax inverter mode, optional manual mode behavior, and/or multiple Solax settings.
    Retries until successful or max loops reached with timeout protection.
  fields:
    mode:
      description: "Optional inverter mode to set (integer, 0,1,3)"
      example: "3"
      required: false
    manual_mode:
      description: "Optional manual mode behavior (integer, 0-2)"
      example: "2"
      required: false
    settings:
      description: "Optional dictionary of Solax settings to set (key: value)"
      example: "{'selfuse_min_soc': 30, 'feedin_min_soc': 20}"
      required: false
  sequence:
    - variables:
        constants:
          max_loops: 5
          max_settings_retries: 5
          refresh_delay: 13 
          settings_delay: 15 
          timeout_seconds: 300 
          mode_delays:
            0: 20
            1: 20
            3: 25
        mode_delay: "{{ constants.mode_delays[mode | int] if mode is defined else 0 }}"
        start_time: "{{ now()|as_timestamp }}"
        outer_loop: 0
        outer_settings_retry_count: 0
        inner_settings_retry_count: 0
        success: false
        mode_names:
          0: Self Use
          1: Feed In Priority
          3: Manual
        manual_mode_names:
          0: Do Nothing
          1: Force Charge
          2: Force Discharge
        mode_text: "{{ mode_names[mode | int] if mode is defined else 'N/A' }}"
        manual_mode_text: |-
          {% if manual_mode is defined %}
            {{ manual_mode_names[manual_mode | int] }}
          {% else %}
            N/A
          {% endif %}
        idx_map: |
          {% set m = {
            'selfuse_battery_min_soc': {'index':0,'service':'solax_local_set_selfuse_battery_min_soc','field':'level'},
            'selfuse_charge_from_grid_enable': {'index':1,'service':'solax_local_set_selfuse_charge_from_grid_enable','field':'enabled'},
            'selfuse_charge_battery_from_grid': {'index':2,'service':'solax_local_set_selfuse_charge_battery_from_grid','field':'level'},
            'forced_charge_start': {'index':3,'service':'solax_local_set_forced_charge_start','field':'value'},
            'forced_charge_end': {'index':4,'service':'solax_local_set_forced_charge_stop','field':'value'},
            'allowed_discharge_start': {'index':5,'service':'solax_local_set_allowed_discharge_start','field':'value'},
            'allowed_discharge_end': {'index':6,'service':'solax_local_set_allowed_discharge_end','field':'value'},
            'period2_enabled': {'index':7,'service':'solax_local_set_period2_enable','field':'enabled'},
            'forced_charge_start2': {'index':8,'service':'solax_local_set_forced_charge_start2','field':'value'},
            'forced_charge_end2': {'index':9,'service':'solax_local_set_forced_charge_stop2','field':'value'},
            'feedin_battery_min_soc': {'index':12,'service':'solax_local_set_feedin_battery_min_soc','field':'level'},
            'feedin_charge_battery_from_grid': {'index':13,'service':'solax_local_set_feedin_charge_battery_from_grid','field':'level'},
            'system_state': {'index':19,'service':'solax_local_set_system_state','field':'enabled'}
          } %}{{ m }}
        # --- Mode-specific valid settings ---
        mode_setting_map:
          0: ["selfuse_battery_min_soc", "selfuse_charge_from_grid_enable", "selfuse_charge_battery_from_grid","forced_charge_start","forced_charge_end","allowed_discharge_start","allowed_discharge_end","period2_enabled","forced_charge_start2","forced_charge_end2"]
          1: ["feedin_battery_min_soc", "feedin_charge_battery_from_grid","forced_charge_start","forced_charge_end","allowed_discharge_start","allowed_discharge_end","period2_enabled","forced_charge_start2","forced_charge_end2"]
          3: []   # Manual: all general settings allowed

        # --- Determine active mode for filtering ---
        active_mode: >
          {% if mode is defined and mode != '' %}
            {{ mode | int }}
          {% else %}
            {{ state_attr('sensor.solax_local_settings','Data')[10] | int }}
          {% endif %}

        # --- Filter settings so only those valid for the chosen mode remain ---
        filtered_settings: >
          {% if settings is defined %}
            {% set valid = mode_setting_map.get(active_mode, []) %}
            {% set r = namespace(data={}) %}
            {% for k, v in settings.items() %}
              {% if k in valid or valid | length == 0 %}
                {% set r.data = r.data | combine({k: v}) %}
              {% endif %}
            {% endfor %}
            {{ dict(r.data) }}
          {% else %}
            {}
          {% endif %}

    - repeat:
        until:
          - condition: template
            value_template: >-
              {{ outer_settings_retry_count >= constants.max_settings_retries or not state_attr('sensor.solax_local_settings','using_cache') }}
        sequence:
          - action: homeassistant.update_entity
            data:
              entity_id:
                - sensor.solax_rest_local_settings
          - delay:
              seconds: "{{ constants.refresh_delay }}"
          - variables:
              current_mode: "{{ state_attr('sensor.solax_local_settings', 'Data')[10] | int }}"
              current_manual_mode: "{{ state_attr('sensor.solax_local_settings', 'Data')[11] | int }}"
              outer_settings_retry_count: "{{ outer_settings_retry_count + 1 }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ outer_settings_retry_count >= constants.max_settings_retries }}"
                sequence:
                  - event: Solax Control
                    event_data:
                      message: Initial settings update failed after max retries
                      title: Solax Set Failure - Action required!
                      class: high
                  - variables:
                      outer_settings_retry_count: "{{ constants.max_settings_retries + 1 }}"
                      outer_loop: "{{ constants.max_loops + 1 }}"
                      success: false

    - variables:
        needs_update: >
          {% set cm = state_attr('sensor.solax_local_settings','Data')[10] | int %}
          {% set cm_manual = state_attr('sensor.solax_local_settings','Data')[11] | int %}
          {% set ns = namespace(all_settings_ok=true) %}

          {# --- Determine active mode for filtering --- #}
          {% set active_mode_for_check = cm %}
          {% set valid = mode_setting_map.get(active_mode_for_check, []) %}
          {% set _fs = namespace(data={}) %}
          {% if filtered_settings is defined and filtered_settings | length > 0 %}
            {% for k, v in filtered_settings.items() %}
              {% if k in valid or valid | length == 0 %}
                {% set _fs.data = _fs.data | combine({k: v}) %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set filtered_settings_post_mode = _fs.data %}

          {# --- Check only relevant settings --- #}
          {% for key, val in filtered_settings_post_mode.items() %}
            {% if state_attr('sensor.solax_local_settings','Data')[idx_map[key].index] | int != val | int %}
              {% set ns.all_settings_ok = false %}
            {% endif %}
          {% endfor %}

          {# --- Determine mode and manual_mode success --- #}
          {% if mode is defined %}
            {% set mode_ok = (cm == mode | int) %}
          {% else %}
            {% set mode_ok = true %}  {# No mode change requested #}
          {% endif %}

          {# --- Check manual_mode success separately --- #}
          {% if manual_mode is defined %}
            {% set manual_ok = (cm_manual == manual_mode | int) %}
          {% else %}
            {% set manual_ok = true %}
          {% endif %}

          {# --- Combine mode, manual_mode & filtered settings --- #}
          {% if filtered_settings_post_mode | length > 0 %}
            {{ not (mode_ok and manual_ok and ns.all_settings_ok) }}
          {% else %}
            {{ not (mode_ok and manual_ok) }}
          {% endif %}
        outer_settings_retry_count: 0  
        inner_settings_retry_count: 0  
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ not needs_update }}"
          sequence:
            - variables:
                success: true
            - action: logbook.log
              data:
                name: Solax Set Mode and Settings
                message: >-
                  No changes required. Mode="{{ mode_text }}", Manual="{{ manual_mode_text }}",
                  Settings="{% if filtered_settings | length > 0 %}{{ filtered_settings.keys() }}{% else %}None{% endif %}"
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ needs_update }}"
          sequence:
            - repeat:
                until:
                  - condition: template
                    value_template: >
                      {{ success or outer_loop >= constants.max_loops or (now()|as_timestamp - start_time) > constants.timeout_seconds }}
                sequence:
                  - variables:
                      outer_loop: "{{ outer_loop + 1 }}"
                      inner_settings_retry_count: 0
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ mode is defined }}"
                        sequence:
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: >-
                                      {{ (state_attr('sensor.solax_local_settings','Data')[10] | int) == 3 and mode is defined and mode | int in [0,1] }}
                                sequence:
                                  - data:
                                      value: 0
                                    action: rest_command.solax_local_set_manual_mode_behaviour
                                  - delay:
                                      seconds: "{{ constants.mode_delays[3] }}"
                          - data:
                              value: "{{ mode | int }}"
                            action: rest_command.solax_local_set_inverter_mode
                          - delay:
                              seconds: "{{ mode_delay }}"
                          # --- Apply manual mode if requested and actually needed ---
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: >-
                                      {{ manual_mode is defined and (state_attr('sensor.solax_local_settings','Data')[11] | int) != (manual_mode | int) }}
                                sequence:
                                  - data:
                                      value: "{{ manual_mode | int }}"
                                    action: rest_command.solax_local_set_manual_mode_behaviour
                                  - delay:
                                      seconds: "{{ constants.mode_delays[3] if mode is defined and mode | int == 3 else constants.refresh_delay }}"

                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ filtered_settings is defined and filtered_settings | length > 0 }}"
                        sequence:
                          - repeat:
                              for_each: "{{ filtered_settings.items() | list }}"
                              sequence:
                                - choose:
                                    - conditions:
                                        - condition: template
                                          value_template: >-
                                            {{ (state_attr('sensor.solax_local_settings','Data')[idx_map[repeat.item.0].index] | int) != (repeat.item.1 | int) }}
                                      sequence:
                                        - data:
                                            "{{ idx_map[repeat.item.0].field }}": "{{ repeat.item.1 }}"
                                          action: >-
                                            rest_command.{{ idx_map[repeat.item.0].service }}
                                        - delay:
                                            seconds: "{{ constants.settings_delay }}"
                  - repeat:
                      until:
                        - condition: template
                          value_template: >-
                            {{ outer_settings_retry_count >= constants.max_settings_retries or not state_attr('sensor.solax_local_settings','using_cache') }}
                      sequence:
                        - action: homeassistant.update_entity
                          data:
                            entity_id:
                              - sensor.solax_rest_local_settings
                        - delay:
                            seconds: "{{ constants.refresh_delay }}"
                        - variables:
                            inner_settings_retry_count: "{{ inner_settings_retry_count + 1 }}"
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ inner_settings_retry_count >= constants.max_settings_retries }}"
                              sequence:
                                - event: Solax Control
                                  event_data:
                                    message: Initial settings update failed after max retries
                                    title: Solax Set Failure - Action required!
                                    class: high
                                - variables:
                                    outer_settings_retry_count: "{{ constants.max_settings_retries + 1 }}"
                                    outer_loop: "{{ constants.max_loops + 1 }}"
                                    success: false
                  - variables:
                      success: >
                        {% set cm = state_attr('sensor.solax_local_settings','Data')[10] | int %}
                        {% set cm_manual = state_attr('sensor.solax_local_settings','Data')[11] | int %}
                        {% set ns = namespace(all_settings_ok=true) %}

                        {# --- Determine current mode and filter settings for this mode --- #}
                        {% set active_mode_for_check = cm %}
                        {% set valid = mode_setting_map.get(active_mode_for_check, []) %}
                        {% set _fs = namespace(data={}) %}
                        {% if filtered_settings is defined and filtered_settings | length > 0 %}
                          {% for k, v in filtered_settings.items() %}
                            {% if k in valid or valid | length == 0 %}
                              {% set _fs.data = _fs.data | combine({k: v}) %}
                            {% endif %}
                          {% endfor %}
                        {% endif %}
                        {% set filtered_settings_post_mode = _fs.data %}

                        {# --- Check only relevant settings --- #}
                        {% for key, val in filtered_settings_post_mode.items() %}
                          {% if state_attr('sensor.solax_local_settings','Data')[idx_map[key].index] | int != val | int %}
                            {% set ns.all_settings_ok = false %}
                          {% endif %}
                        {% endfor %}

                        {# --- Determine mode success --- #}
                        {% if mode is defined %}
                          {% set mode_ok = (cm == mode | int) %}
                        {% else %}
                          {% set mode_ok = true %}
                        {% endif %}

                        {# --- Determine manual mode success --- #}
                        {% if manual_mode is defined %}
                          {% set manual_ok = (cm_manual == manual_mode | int) %}
                        {% else %}
                          {% set manual_ok = true %}
                        {% endif %}

                        {# --- Combine all checks --- #}
                        {% if filtered_settings_post_mode | length > 0 %}
                          {{ mode_ok and manual_ok and ns.all_settings_ok }}
                        {% else %}
                          {{ mode_ok and manual_ok }}
                        {% endif %}


    - choose:
        - conditions:
            - condition: template
              value_template: "{{ not success }}"
          sequence:
            - event: Solax Control
              event_data:
                message: Solax mode/settings update failed after max retries
                title: Solax Set Failure
                class: high

