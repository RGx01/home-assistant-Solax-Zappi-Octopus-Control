octoplus_sessions_octoplus_templates:
  template:
    ######################################################
    # Octopus free/saving sensors
    # V8.0.0   Refactor
    ######################################################

    ######################################################
    #Octopus free electric start
    ######################################################
    - sensor:
        - name: Octopus Free Electricity Start
          unique_id: octopus_free_electricity_start
          device_class: "timestamp"
          state: >
            {{as_datetime(state_attr('input_datetime.octopus_free_electricity_start','timestamp')-120)|as_local}}

    ######################################################
    #Octopus free electric stop
    ######################################################
    - sensor:
        - name: Octopus Free Electricity Stop
          unique_id: octopus_free_electricity_stop
          device_class: "timestamp"
          state: >
            {{as_datetime(state_attr('input_datetime.octopus_free_electricity_stop','timestamp')-30)|as_local}}

    ######################################################
    # binary_sensor.free_electricity_today
    ######################################################
    - binary_sensor:
        - name: Free Electricity Today
          unique_id: free_electricity_today
          # This binary sensor shows ON if today has a free electricity session
          # and is currently still running.
          # Otherwise, it is OFF.
          state: >
            {% set events = state_attr('sensor.octoplus_free_electricity_session_events','events') or [] %}
            {% set now_dt = now() %}
            {% set ns = namespace(today_event=None) %}

            {# Find today’s event #}
            {% for e in events %}
              {% if e.start is defined %}
                {% set e_start = e.start | as_datetime | as_local %}
                {% if e_start.date() == now_dt.date() %}
                  {% set ns.today_event = e %}
                {% endif %}
              {% endif %}
            {% endfor %}

            {% if ns.today_event is not none and ns.today_event.end is defined %}
              {% set end_dt = ns.today_event.end | as_datetime | as_local %}
              {{ now_dt < end_dt }}
            {% else %}
              false
            {% endif %}

          attributes:
            session_start: >
              {# Attribute that holds the start time of the "current" session: #}
              {# - If there is a session today, it shows today’s start. #}
              {# - If no session today, it shows the start of the *next upcoming* session. #}
              {# - If no future sessions exist, it falls back to the last known session. #}
              {% set events = state_attr('sensor.octoplus_free_electricity_session_events','events') or [] %}
              {% set now_dt = now() %}
              {% set ns = namespace(today_event=None, future_events=[]) %}

              {# Find today’s event #}
              {% for e in events %}
                {% if e.start is defined %}
                  {% set e_start = e.start | as_datetime | as_local %}
                  {% if e_start.date() == now_dt.date() %}
                    {% set ns.today_event = e %}
                  {% elif e_start > now_dt %}
                    {% set ns.future_events = ns.future_events + [e] %}
                  {% endif %}
                {% endif %}
              {% endfor %}

              {% if ns.today_event is not none and ns.today_event.start is defined %}
                {{ ns.today_event.start | as_datetime | as_local }}
              {% elif ns.future_events | length > 0 %}
                {% set next_event = ns.future_events | sort(attribute='start') | first %}
                {% if next_event.start is defined %}
                  {{ next_event.start | as_datetime | as_local }}
                {% else %}
                  none
                {% endif %}
              {% elif events | length > 0 %}
                {% set last_event = events[-1] %}
                {% if last_event.start is defined %}
                  {{ last_event.start | as_datetime | as_local }}
                {% else %}
                  none
                {% endif %}
              {% else %}
                none
              {% endif %}

            session_end: >
              {# Attribute that holds the end time of the "current" session: #}
              {# - Today’s end if there is one. #}
              {# - Next session’s end if there isn’t one today.#}
              {# - Falls back to the last known session’s end if no future events exist. #}
              {% set events = state_attr('sensor.octoplus_free_electricity_session_events','events') or [] %}
              {% set now_dt = now() %}
              {% set ns = namespace(today_event=None, future_events=[]) %}

              {# Find today and future events #}
              {% for e in events %}
                {% if e.start is defined %}
                  {% set e_start = e.start | as_datetime | as_local %}
                  {% if e_start.date() == now_dt.date() %}
                    {% set ns.today_event = e %}
                  {% elif e_start > now_dt %}
                    {% set ns.future_events = ns.future_events + [e] %}
                  {% endif %}
                {% endif %}
              {% endfor %}

              {% if ns.today_event is not none and ns.today_event.end is defined %}
                {{ ns.today_event.end | as_datetime | as_local }}
              {% elif ns.future_events | length > 0 %}
                {% set next_event = ns.future_events | sort(attribute='start') | first %}
                {% if next_event.end is defined %}
                  {{ next_event.end | as_datetime | as_local }}
                {% else %}
                  none
                {% endif %}
              {% elif events | length > 0 %}
                {% set last_event = events[-1] %}
                {% if last_event.end is defined %}
                  {{ last_event.end | as_datetime | as_local }}
                {% else %}
                  none
                {% endif %}
              {% else %}
                none
              {% endif %}

            duration: >
              {# Attribute that holds the duration (minutes) of the "current" session: #}
              {# - Today’s duration if today has a session. #}
              {# - Next upcoming session’s duration if not today. #}
              {# - Falls back to the last known session duration if no future exists. #}
              {% set events = state_attr('sensor.octoplus_free_electricity_session_events','events') or [] %}
              {% set now_dt = now() %}
              {% set ns = namespace(today_event=None, future_events=[]) %}

              {# Find today and future events #}
              {% for e in events %}
                {% if e.start is defined %}
                  {% set e_start = e.start | as_datetime | as_local %}
                  {% if e_start.date() == now_dt.date() %}
                    {% set ns.today_event = e %}
                  {% elif e_start > now_dt %}
                    {% set ns.future_events = ns.future_events + [e] %}
                  {% endif %}
                {% endif %}
              {% endfor %}

              {% if ns.today_event is not none and ns.today_event.duration_in_minutes is defined %}
                {{ ns.today_event.duration_in_minutes | int }}
              {% elif ns.future_events | length > 0 %}
                {% set next_event = ns.future_events | sort(attribute='start') | first %}
                {% if next_event.duration_in_minutes is defined %}
                  {{ next_event.duration_in_minutes | int }}
                {% else %}
                  0
                {% endif %}
              {% elif events | length > 0 %}
                {% set last_event = events[-1] %}
                {% if last_event.duration_in_minutes is defined %}
                  {{ last_event.duration_in_minutes | int }}
                {% else %}
                  0
                {% endif %}
              {% else %}
                0
              {% endif %}

################################################################

    - trigger: 
        # Trigger whenever session_start attribute changes
        - trigger: state
          entity_id: binary_sensor.free_electricity_today
          attribute: session_start

        # Trigger whenever session_end attribute changes
        - trigger: state
          entity_id: binary_sensor.free_electricity_today
          attribute: session_end

        # Fallback: also update once per minute
        # (avoids "1970-01-01" default issue on HA restart,
        #  ensures input_datetimes always sync with attributes)
        - trigger: time_pattern
          minutes: "/1"
      binary_sensor:
        - name: "Free Electric Helper"
          unique_id: free_electric_helper
          state: >
            true
          attributes:
            description: >
              "nonsence sensor required by HA2026.5. Essentially you can't have something that is essentially an automation in a template without defining a sensor. I'll sort it out someday"

      action:
        # Update input_datetime for session start
        - service: input_datetime.set_datetime
          data:
            timestamp: >
              {% set ts = state_attr('binary_sensor.free_electricity_today','session_start') %}
              {{ ts | as_timestamp(default=0) }}
          target:
            entity_id: input_datetime.octopus_free_electricity_start

        # Update input_datetime for session end
        - service: input_datetime.set_datetime
          data:
            timestamp: >
              {% set ts = state_attr('binary_sensor.free_electricity_today','session_end') %}
              {{ ts | as_timestamp(default=0) }}
          target:
            entity_id: input_datetime.octopus_free_electricity_stop

################################################################

    - binary_sensor:
        - name: Upcoming Free Electricity
          unique_id: upcoming_free_electricity
          # This binary sensor shows ON if there is an upcoming free electricity session
          # (not today), and OFF otherwise.
          # Rules:
          # - If today's session exists and has not finished yet → OFF
          # - If today's session has finished and another session is scheduled later → ON
          # - If there are no sessions at all → OFF
          state: >
            {% set events = state_attr('sensor.octoplus_free_electricity_session_events','events') %}
            {% set now_dt = now() %}
            {% if events %}
              {# collect all events that start after now into a namespace #}
              {% set ns = namespace(future_events=[]) %}
              {% for e in events %}
                {% if e.start not in [none,''] %}
                  {% set e_start_dt = e.start | as_datetime %}
                  {% if e_start_dt > now_dt %}
                    {% set ns.future_events = ns.future_events + [e] %}
                  {% endif %}
                {% endif %}
              {% endfor %}

              {# sort by start time and take the earliest future event #}
              {% set ns.future_events = ns.future_events | sort(attribute='start') %}
              {% set next_event = ns.future_events[0] if ns.future_events | length > 0 else none %}

              {% if next_event %}
                {% set next_start = next_event['start'] | as_datetime | as_local %}
                {% set next_end   = next_event['end']   | as_datetime | as_local %}

                {# If the next event is today and it hasn't finished yet → OFF #}
                {# Otherwise (tomorrow or later) → ON #}
                {% if next_start.date() == now_dt.date() and now_dt <= next_end %}
                  false
                {% else %}
                  true
                {% endif %}
              {% else %}
                false
              {% endif %}
            {% else %}
              false
            {% endif %}

          attributes:
            next_session_start: >
              {# Start time of the next future session (if any) #}
              {% set events = state_attr('sensor.octoplus_free_electricity_session_events','events') %}
              {% set now_dt = now() %}
              {% set ns = namespace(future_events=[]) %}
              {% if events %}
                {% for e in events %}
                  {% if e.start not in [none,''] %}
                    {% set e_start_dt = e.start | as_datetime %}
                    {% if e_start_dt > now_dt %}
                      {% set ns.future_events = ns.future_events + [e] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {% set ns.future_events = ns.future_events | sort(attribute='start') %}
                {% set next_event = ns.future_events[0] if ns.future_events | length > 0 else none %}
                {{ next_event['start'] | as_datetime | as_local if next_event else none }}
              {% else %}
                none
              {% endif %}

            next_session_end: >
              {# End time of the next future session (if any) #}
              {% set events = state_attr('sensor.octoplus_free_electricity_session_events','events') %}
              {% set now_dt = now() %}
              {% set ns = namespace(future_events=[]) %}
              {% if events %}
                {% for e in events %}
                  {% if e.start not in [none,''] %}
                    {% set e_start_dt = e.start | as_datetime %}
                    {% if e_start_dt > now_dt %}
                      {% set ns.future_events = ns.future_events + [e] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {% set ns.future_events = ns.future_events | sort(attribute='start') %}
                {% set next_event = ns.future_events[0] if ns.future_events | length > 0 else none %}
                {{ next_event['end'] | as_datetime | as_local if next_event else none }}
              {% else %}
                none
              {% endif %}

            next_session_duration: >
              {# Duration (minutes) of the next future session (if any) #}
              {% set events = state_attr('sensor.octoplus_free_electricity_session_events','events') %}
              {% set now_dt = now() %}
              {% set ns = namespace(future_events=[]) %}
              {% if events %}
                {% for e in events %}
                  {% if e.start not in [none,''] %}
                    {% set e_start_dt = e.start | as_datetime %}
                    {% if e_start_dt > now_dt %}
                      {% set ns.future_events = ns.future_events + [e] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {% set ns.future_events = ns.future_events | sort(attribute='start') %}
                {% set next_event = ns.future_events[0] if ns.future_events | length > 0 else none %}
                {{ next_event['duration_in_minutes'] | int if next_event else 0 }}
              {% else %}
                0
              {% endif %}



    - trigger:
        # Update every 15 minutes
        - platform: time_pattern
          minutes: "/15"

        # Also update on HA startup
        - platform: homeassistant
          event: start

      action:
        # 1️⃣ Discover calendar dynamically
        - variables:
            octoplus_cal: >
              {{ states.calendar
                | selectattr('entity_id','search','_octoplus_free_electricity_session$')
                | map(attribute='entity_id')
                | first
              }}

        # 2️⃣ Fetch past events (last 730 days)
        - service: calendar.get_events
          target:
            entity_id: "{{ octoplus_cal }}"
          data:
            start_date_time: "{{ (now() - timedelta(days=730)).isoformat() }}"
            end_date_time: "{{ now().isoformat() }}"
          response_variable: past_events

        # 3️⃣ Fetch future events (next 365 days)
        - service: calendar.get_events
          target:
            entity_id: "{{ octoplus_cal }}"
          data:
            start_date_time: "{{ now().isoformat() }}"
            end_date_time: "{{ (now() + timedelta(days=30)).isoformat() }}"
          response_variable: future_events

      sensor:
        - name: Octoplus Free Electricity Session Events
          unique_id: octoplus_free_electricity_session_events
          state: "ok"
          attributes:
            events: >
              {% set cal = octoplus_cal %}
              {% set past = past_events[cal].events if past_events and cal in past_events else [] %}
              {% set future = future_events[cal].events if future_events and cal in future_events else [] %}
              {% set all_events = past + future %}

              {% set ns = namespace(normalized=[]) %}
              {% for e in all_events %}
                {% if e.start is defined and e.end is defined %}
                  {% set start_dt = e.start | as_datetime | as_local %}
                  {% set end_dt = e.end | as_datetime | as_local %}
                  {% set duration = ((end_dt - start_dt).total_seconds() / 60) | int %}
                  {% set ns.normalized = ns.normalized + [{
                    'code': loop.index|string,
                    'start': start_dt.isoformat(),
                    'end': end_dt.isoformat(),
                    'duration_in_minutes': duration
                  }] %}
                {% endif %}
              {% endfor %}

              {{ ns.normalized }}


