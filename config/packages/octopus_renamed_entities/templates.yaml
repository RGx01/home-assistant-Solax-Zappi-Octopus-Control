###############################################
# Replace octopus account number z_ZZZZZZZZ
# V5.0. Refactor
###############################################
octopus_renamed_entities_templates:
  template:
    ######################################################
    # Octopus target time normalised to remove account number in automations
    ######################################################
    - select:
        - name: "Octopus Intelligent Target Time"
          unique_id: octopus_intelligent_target_time
          icon: mdi:battery-clock
          state: "{{ states('select.octopus_energy_z_ZZZZZZZZ_intelligent_target_time') }}"
          options: >
            {{ state_attr('select.octopus_energy_z_ZZZZZZZZ_intelligent_target_time', 'options') }}
          select_option:
            - service: select.select_option
              target:
                entity_id: select.octopus_energy_z_ZZZZZZZZ_intelligent_target_time
              data:
                option: "{{ option }}"

    ######################################################
    # Octopus charge target normalised to remove account number in automations
    ######################################################

    - number:
        - name: "Octopus Intelligent Charge Target"
          unique_id: octopus_intelligent_charge_target
          state: "{{ states('number.octopus_energy_z_ZZZZZZZZ_intelligent_charge_target') | float }}"
          icon: mdi:battery-charging
          min: 10
          max: 100
          step: 1
          set_value:
            - service: number.set_value
              target:
                entity_id: number.octopus_energy_z_ZZZZZZZZ_intelligent_charge_target
              data:
                value: "{{ value }}"


    ######################################################
    # Octopus intelligent smart charge switch normalised to remove account number in automations
    ######################################################
    - switch:
        - name: "Octopus Intelligent Smart Charge"
          unique_id: octopus_intelligent_smart_charge
          icon: mdi:ev-station
          state: >
            {{ is_state('switch.octopus_energy_z_ZZZZZZZZ_intelligent_smart_charge', 'on') }}
          turn_on:
            - service: switch.turn_on
              target:
                entity_id: switch.octopus_energy_z_ZZZZZZZZ_intelligent_smart_charge
          turn_off:
            - service: switch.turn_off
              target:
                entity_id: switch.octopus_energy_z_ZZZZZZZZ_intelligent_smart_charge


    ######################################################
    # Octopus Dispatch avoiding unknown when cloud response is not available
    # Also automations don't need customising
    ######################################################

    - binary_sensor:
      - name: Octopus Intelligent Dispatching
        unique_id: Octopus_intelligent_dispatching
        state: >
          {% set s = states('binary_sensor.octopus_energy_z_ZZZZZZZZ_intelligent_dispatching') %}
          {% if s in ['unavailable', 'unknown'] %}
            off
          {% else %}
            {{ s }}
          {% endif %}
        icon: mdi:power-plug-battery
        attributes: 
          planned_dispatches: >
            {% set ns = namespace(out=[]) %}
            {% for item in state_attr('binary_sensor.octopus_energy_z_ZZZZZZZZ_intelligent_dispatching','planned_dispatches') or ns.out %}
              {% set start = item.start if item.start is string else (item.start.isoformat() if item.start is not none else none) %}
              {% set end   = item.end   if item.end   is string else (item.end.isoformat()   if item.end   is not none else none) %}
              {% set new = dict(item) %}
              {% set new = new | combine({'start': start, 'end': end}) %}
              {% set ns.out = ns.out + [new] %}
            {% endfor %}
            {{ ns.out }}

          completed_dispatches: >
            {% set ns = namespace(out=[]) %}
            {% for item in state_attr('binary_sensor.octopus_energy_z_ZZZZZZZZ_intelligent_dispatching','completed_dispatches') or ns.out %}
              {% set start = item.start if item.start is string else (item.start.isoformat() if item.start is not none else none) %}
              {% set end   = item.end   if item.end   is string else (item.end.isoformat()   if item.end   is not none else none) %}
              {% set new = dict(item) %}
              {% set new = new | combine({'start': start, 'end': end}) %}
              {% set ns.out = ns.out + [new] %}
            {% endfor %}
            {{ ns.out }}

          started_dispatches: >
            {% set ns = namespace(out=[]) %}
            {% for item in state_attr('binary_sensor.octopus_energy_z_ZZZZZZZZ_intelligent_dispatching','started_dispatches') or ns.out %}
              {% set start = item.start if item.start is string else (item.start.isoformat() if item.start is not none else none) %}
              {% set end   = item.end   if item.end   is string else (item.end.isoformat()   if item.end   is not none else none) %}
              {% set new = dict(item) %}
              {% set new = new | combine({'start': start, 'end': end}) %}
              {% set ns.out = ns.out + [new] %}
            {% endfor %}
            {{ ns.out }}

          provider: >
            {% set val = state_attr('binary_sensor.octopus_energy_z_ZZZZZZZZ_intelligent_dispatching','provider') %}
            {% if val is not none %}{{ val }}{% else %}{{ states('binary_sensor.octopus_intelligent_dispatching') | attr('provider') or 'MYENERGI_V2' }}{% endif %}

          vehicle_battery_size_in_kwh: >
            {% set val = state_attr('binary_sensor.octopus_energy_z_ZZZZZZZZ_intelligent_dispatching','vehicle_battery_size_in_kwh') %}
            {% if val is not none %}{{ val }}{% else %}{{ states('binary_sensor.octopus_intelligent_dispatching') | attr('vehicle_battery_size_in_kwh') }}{% endif %}

          charge_point_power_in_kw: >
            {% set val = state_attr('binary_sensor.octopus_energy_z_ZZZZZZZZ_intelligent_dispatching','charge_point_power_in_kw') %}
            {% if val is not none %}{{ val }}{% else %}{{ states('binary_sensor.octopus_intelligent_dispatching') | attr('charge_point_power_in_kw') }}{% endif %}

          current_start: >
            {% set val = state_attr('binary_sensor.octopus_energy_z_ZZZZZZZZ_intelligent_dispatching','current_start') %}
            {% if val is not none %}{{ val }}{% else %}{{ states('binary_sensor.octopus_intelligent_dispatching') | attr('current_start') }}{% endif %}

          current_end: >
            {% set val = state_attr('binary_sensor.octopus_energy_z_ZZZZZZZZ_intelligent_dispatching','current_end') %}
            {% if val is not none %}{{ val }}{% else %}{{ states('binary_sensor.octopus_intelligent_dispatching') | attr('current_end') }}{% endif %}

          next_start: >
            {% set val = state_attr('binary_sensor.octopus_energy_z_ZZZZZZZZ_intelligent_dispatching','next_start') %}
            {% if val is not none %}{{ val }}{% else %}{{ states('binary_sensor.octopus_intelligent_dispatching') | attr('next_start') }}{% endif %}

          next_end: >
            {% set val = state_attr('binary_sensor.octopus_energy_z_ZZZZZZZZ_intelligent_dispatching','next_end') %}
            {% if val is not none %}{{ val }}{% else %}{{ states('binary_sensor.octopus_intelligent_dispatching') | attr('next_end') }}{% endif %}
