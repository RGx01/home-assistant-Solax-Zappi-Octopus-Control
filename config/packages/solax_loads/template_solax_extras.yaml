solax_loads_template_solax_extras:
  template:
    - sensor:
      
    ######################################################
    # v10.2.0 Battery Heating binary sensor and power calc
    # v1.0.0
    # Extended Solax realtime data    
    # new experimental sensors have been added:
    # - name: "Solax Local Self Consumption Power"
    # - name: "Solax Local Battery In From Solar"
    # - name: "Solax Local Battery Dump Power"
    # - name: "Solax Local House Load Power"
    ######################################################
        - name: "Solax Local House Load Power"
          unique_id: solax_local_house_load_power
          # if your solax system can see load from zappi then set solax_can_see_zappi_load =1 else set it to 0
          state: >
            {% set solax_can_see_zappi_load = states('input_boolean.solax_can_see_zappi_loads') %}
            {% set zappi_raw = states('sensor.zappi_power_ct_internal_load') %}
            {% set grid_raw = states('sensor.zappi_power_ct_grid_load') %}
            {% set feedin_raw = states('sensor.solax_local_feedin_power') %}
            {% set inv_raw = states('sensor.solax_local_inverter_power') %}

            {# ---- Safely convert to numbers ---- #}
            {% set zappi = zappi_raw if zappi_raw not in ['unavailable','unknown','None', none, ''] else 0 %}
            {% set grid = grid_raw if grid_raw not in ['unavailable','unknown','None', none, ''] else 0 %}
            {% set feedin = feedin_raw if feedin_raw not in ['unavailable','unknown','None', none, ''] else 0 %}
            {% set inv = inv_raw if inv_raw not in ['unavailable','unknown','None', none, ''] else 0 %}

            {% set zappi_load_fiddle = 0 %}
            {% if zappi | int != 0 %}
                {% set zappi_load_fiddle = (zappi | float) - ((grid | float) + (feedin | float)) %}
            {% endif %}

            {% if solax_can_see_zappi_load == 'on' %}
                {{ (inv | float) - (feedin | float) - (zappi_load_fiddle | float) }}
            {% else %}
                {{ (inv | float) - (feedin | float) }}
            {% endif %}
          unit_of_measurement: "W"
          device_class: "power"
          state_class: measurement

        - name: "Solax Local Battery Cell Voltage"
          unique_id: solax_local_battery_cell_voltage
          state: >
            {% set v = states('sensor.solax_local_battery_voltage') %}
            {% set c = states('input_number.solax_battery_capacity') %}
            {% set old = states('sensor.solax_local_battery_cell_voltage') | float(none) %}

            {% if v not in ['unknown', 'unavailable', 'none']
                  and c not in ['unknown', 'unavailable', 'none'] %}
              {% set voltage = v | float(default=none) %}
              {% set capacity = c | float(default=none) %}
              {% if voltage is not none and capacity is not none and capacity > 0 %}
                {{ (voltage / (capacity|int / 3 * 31)) | round(3) }}
              {% elif old is not none %}
                {{ old }}
              {% else %}
                {{ none }}
              {% endif %}
            {% elif old is not none %}
              {{ old }}
            {% else %}
              {{ none }}
            {% endif %}
          unit_of_measurement: "V"
          state_class: measurement
          device_class: "voltage"

    # Estimated remaining energy       
        - name: "Solax Local Battery Remaining Energy"
          unique_id: solax_local_battery_kwh
          state: "{{ (states('sensor.solax_local_battery_soc')|int(100) - states('input_number.solax_default_discharge_limit_soc')|int(10)) /100 * states('input_number.solax_battery_capacity')|float(12.3) }}"
          unit_of_measurement: "kWh"
          device_class: "energy"
          state_class: total

    # Battery in power (charging from grid)
        - name: "Solax Local Battery Use In From Grid"
          unique_id: solax_local_battery_use_in_from_grid
          state: >
            {% set gridPwr = states('sensor.solax_local_grid_used_power')|int(default=0) %}
            {% set pvPwr = min(states('sensor.solax_local_pv_output')|float(0)*0.95,states('input_number.solax_inverter_capacity')|float(5.6)*1000)|int (default=0) %}
            {% set bat = states('sensor.solax_local_battery_power')|int(0) - pvPwr|int  %}
            {{ bat if is_number(bat) and (bat|int > 0 and gridPwr > 0) else 0 }}
          unit_of_measurement: "W"
          state_class: measurement
          device_class: "power"
          icon: mdi:battery

        # Battery in power (charging from solar, may need to consider how much more efficent as its pure DC to DC? I was using a loss based on excess inververt power but it doesn't tally with whats already been consumed. i.e. topping up the battery from solar eems far more efficent)
        - name: "Solax Local Battery In From Solar"
          unique_id: solax_local_battery_in_from_solar
          state: >
            {% set grid = states('sensor.solax_local_battery_use_in_from_grid')|int (default = 0) %}
            {% set bat = states('sensor.solax_local_battery_use_in')|int(0) - grid|int%}
            {% set pvPwr = min(states('sensor.solax_local_pv_output')|float(0)*0.95,states('input_number.solax_inverter_capacity')|float(5.6)*1000)|int (default=0) %}
            {{ (bat) if  (pvPwr >0) else 0 }}
            {# (bat-grid) #}
          unit_of_measurement: "W"
          state_class: measurement
          device_class: power
          icon: mdi:battery
      
        # Battery Export power (discharging)
        - name: "Solax Local Battery Dump Power"
          unique_id: solax_local_battery_dump_power
          state: >
            {# ---- Safe sensor values ---- #}
            {% set batAdj_raw = states('sensor.solax_local_battery_power_adjusted') %}
            {% set inverter_cap_raw = states('input_number.solax_inverter_capacity') %}
            {% set batAdj = 0 %}
            {% if batAdj_raw not in ['unavailable', 'unknown', 'None', none, ''] and inverter_cap_raw not in ['unavailable', 'unknown', 'None', none, ''] %}
                {% set batAdj = [batAdj_raw | int, inverter_cap_raw | float * -1000] | max | int %}
            {% endif %}

            {% set inv_power_raw = states('sensor.solax_local_inverter_power') %}
            {% set feedin_raw = states('sensor.solax_local_feedin_power') %}
            {% set load = 0 %}
            {% if inv_power_raw not in ['unavailable', 'unknown', 'None', none, ''] and feedin_raw not in ['unavailable', 'unknown', 'None', none, ''] %}
                {% set load = (inv_power_raw | float) - (feedin_raw | float) %}
            {% endif %}

            {# ---- Main logic ---- #}
            {% if states('sensor.solax_local_inverter_mode') == 'Manual' and 
                  states('sensor.solax_local_manual_mode_behaviour') == 'Force Discharge' %}
                {{ (0 - batAdj-load) if batAdj < 0 else 0 }}
            {% else %}
                0
            {% endif %}
          unit_of_measurement: "W"
          state_class: measurement
          device_class: "power"

        # Battery out power (discharging)
        - name: "Solax Local Battery Use Out"
          unique_id: solax_local_battery_use_out
          state: >
            {# ---- Safe sensor values ---- #}
            {% set batAdj_raw = states('sensor.solax_local_battery_power_adjusted') %}
            {% set batAdj = batAdj_raw if batAdj_raw not in ['unavailable', 'unknown', 'None', none, ''] else 0 %}
            {% set batAdj = batAdj | int %}

            {% set pvPwr_raw = states('sensor.solax_local_pv_output') %}
            {% set inverter_cap_raw = states('input_number.solax_inverter_capacity') %}
            {% set pvPwr = 0 %}
            {% if pvPwr_raw not in ['unavailable', 'unknown', 'None', none, ''] and inverter_cap_raw not in ['unavailable', 'unknown', 'None', none, ''] %}
                {% set pvPwr = [pvPwr_raw | float * 0.95, inverter_cap_raw | float * 1000] | min | int %}
            {% endif %}

            {% set inv_power_raw = states('sensor.solax_local_inverter_power') %}
            {% set feedin_raw = states('sensor.solax_local_feedin_power') %}
            {% set load = 0 %}
            {% if inv_power_raw not in ['unavailable', 'unknown', 'None', none, ''] and feedin_raw not in ['unavailable', 'unknown', 'None', none, ''] %}
                {% set load = (inv_power_raw | float) - (feedin_raw | float) %}
            {% endif %}

            {# ---- Main logic ---- #}
            {% if states('sensor.solax_local_inverter_mode') != 'Manual' %}
            {# and states('sensor.solax_local_manual_mode_behaviour') != 'Force Discharge' #}
                {{ (0 - batAdj) if batAdj < 0 else 0 }}
            {% elif states('sensor.solax_local_inverter_mode') == 'Manual' 
                    and states('sensor.solax_local_manual_mode_behaviour') == 'Force Discharge' %}
                {{ (load - pvPwr) if load > pvPwr else 0 }}
            {% else %}
                0
            {% endif %}
          unit_of_measurement: "W"
          state_class: measurement
          device_class: power
          icon: mdi:battery


        # Ball park numbers
        - name: "Solax Local Battery unknown"
          unique_id: solax_local_battery_unknown
          unit_of_measurement: "W"
          state_class: measurement
          device_class: power
          icon: mdi:battery
          state: >
            {% set B = states('sensor.solax_local_battery_power')|float(0) %}
            {% set I = states('sensor.solax_local_inverter_power')|float(0) %}
            {% set P = states('sensor.solax_local_pv_output')|float(0) %}

            {% set B_dis = (-B) if B < 0 else 0 %}
            {% set PV_ac = P * 0.95 %}
            {% set B_req = (I - PV_ac)|clamp(0, I) %}

            {{ (B_dis - B_req) if (B_dis - B_req) > 0 else 0 }}

        # Heater power estimated from DC balance:
        # PV_ac − inverter_AC − battery_power
        # Assumes ~95% PV→DC efficiency
        # Includes both PV-fed and battery-fed heater load
        - name: "Solax Local Battery Heating Power"
          unique_id: solax_local_battery_heating_power
          unit_of_measurement: "W"
          state_class: measurement
          device_class: power
          icon: mdi:heating-coil
          state: >
            {% set P = states('sensor.solax_local_pv_output')|float(0) * 0.95 %}
            {% set I = states('sensor.solax_local_inverter_power')|float(0) %}
            {% set B = states('sensor.solax_local_battery_power')|float(0) %}

            {% set raw = max(0, P - I - B) %}

            {# Ignore heater inference during strong charge or discharge #}
            {% set BUS_DOMINANT_TH = 2000 %}

            {% if B | abs > BUS_DOMINANT_TH %}
              0
            {% else %}
              {{ raw }}
            {% endif %}


    ##############################################################      
    # delay on/off is set to 2 minutes to prevent false positives.
    ##############################################################   
    - binary_sensor:
        - name: "Solax Local Battery Heating"
          unique_id: solax_local_battery_heating
          icon: mdi:heating-coil
          state: >
            {% set capacity = states('input_number.solax_battery_capacity')|float(0) %}
            {% set pack_count = (capacity / 3)|int(1) %}

            {% set heating_power =
              states('sensor.solax_local_battery_heating_power')|float(0)
            %}

            {% set ON_TH  = pack_count * 100 %}
            {% set OFF_TH = pack_count * 60 %}

            {% set prev =
              is_state('binary_sensor.solax_local_battery_heating','on')
            %}

            {{
              (not prev and heating_power > ON_TH)
              or
              (prev and heating_power > OFF_TH)
            }}
          delay_on:
            minutes: 2
          delay_off:
            minutes: 2


    - sensor:
        ### Inverter default working mode
        - name: "Solax Default Operation Mode"
          unique_id: solax_default_operation_mode
          device_class: enum
          state: >
            {% set mapper =  {
                'Self Use' : 0,
                'Feed In Priority' : 1} %}
            {% set state =  states('input_select.solax_default_mode')  %}
            {{ mapper[state] if state in mapper else '0' }}
          icon: mdi:cursor-default-outline

      

    ######################################################
    # Binary sensor for when house battery is supposed to be charging
    ######################################################
    - binary_sensor:
      - name: Solax Local Battery Charging Period Unsafe
        unique_id: solax_local_battery_charging_period_unsafe
        state: >
          {% set start1 = (states('input_datetime.solax_battery_start_charge_time') or '00:00').split(':') %}
          {% set stop1  = (states('input_datetime.solax_battery_stop_charge_time') or '00:00').split(':') %}
          {% set start2 = (states('input_datetime.solax_start_charge_2') or '00:00').split(':') %}
          {% set stop2  = (states('input_datetime.solax_stop_charge_2') or '00:00').split(':') %}
          {% set start1m = start1[0]|int * 60 + start1[1]|int %}
          {% set stop1m  = stop1[0]|int * 60 + stop1[1]|int %}
          {% set start2m = start2[0]|int * 60 + start2[1]|int %}
          {% set stop2m  = stop2[0]|int * 60 + stop2[1]|int %}
          {% set nowm    = now().hour * 60 + now().minute %}

          {% set period2 = is_state('input_boolean.solaxchargeperiod2', 'on') %}
          {% set mode = states('sensor.solax_local_inverter_mode') or '' %}
          {% set chrgfromgrid = states('sensor.solax_local_self_use_battery_charge_from_grid') | int(0) %}

          {% set in_period1 = (start1m <= stop1m and start1m <= nowm <= stop1m)
              or (start1m > stop1m and (nowm >= start1m or nowm <= stop1m)) %}
          {% set in_period2 = (start2m <= stop2m and start2m <= nowm <= stop2m)
              or (start2m > stop2m and (nowm >= start2m or nowm <= stop2m)) %}

          {{ (in_period1 and (mode == 'Feed In Priority' or chrgfromgrid == 1))
            or (period2 and in_period2 and (mode == 'Feed In Priority' or chrgfromgrid == 1)) }}

    - trigger:
        - trigger: state
          entity_id: binary_sensor.solax_local_battery_charging_period_unsafe
          not_to:
            - unavailable
            - unknown
      binary_sensor:
        - name: Solax Local Battery Charging Period
          unique_id: solax_local_battery_charging_period
          state: >
            {{ trigger.to_state.state if trigger is defined else states('binary_sensor.solax_local_battery_charging_period') }}
          attributes:
            last_triggered: >-
              {{ trigger.to_state.last_changed if trigger is defined else states.binary_sensor.solax_local_battery_charging_period.last_changed }}
          availability: >
            true

    ######################################################
    # discharge capacity solax battery
    ######################################################
    - sensor:
      - name: Solax Discharge Capacity
        unique_id: solax_discharge_capacity
        unit_of_measurement: "kWh"
        device_class: "energy"
        state_class: total
        state: >
          {% set soc = states('sensor.solax_local_battery_soc') %}
          {% set limit = states('input_number.solax_default_discharge_limit_soc') %}
          {% set capacity = states('input_number.solax_battery_capacity') %}
          {% set soh = states('sensor.solax_local_battery_soh') %}
          
          {% if soc in ['unknown', 'unavailable', 'none']
                or limit in ['unknown', 'unavailable', 'none']
                or capacity in ['unknown', 'unavailable', 'none']
                or soh in ['unknown', 'unavailable', 'none'] %}
            {{ none }}
          {% else %}
            {% set battery_soh = (soh | float(100) / 100) %}
            {% set capacity_left = ((soc | int - limit | int) / 100) * (capacity | float) * battery_soh %}
            {{ [capacity_left, 0] | max | round(2) }}
          {% endif %}
        attributes:
          usable_capacity: >
            {% set battery_soh = (states('sensor.solax_local_battery_soh')|float (default=100)/100)|float%} 
            {% set usable = (100- states('input_number.solax_default_discharge_limit_soc')|int (default=15)) /100 * states('input_number.solax_battery_capacity')|float (default=9.2) * battery_soh|float%}
            {{usable|float (default=0.0)}}
        icon: mdi:battery

    # - sensor:
    #     - name: alternative Solax Battery SoC
    #       unique_id: alternative_solax_battery_soc
    #       unit_of_measurement: "%"
    #       device_class: battery
    #       icon: mdi:battery
    #       state: >
    #         {# --- retrieve last valid SOC --- #}
    #         {% set last = state_attr('sensor.alternative_solax_battery_soc', 'last_valid_soc') %}

    #         {# get inputs #}
    #         {% set usable_capacity = state_attr('sensor.solax_discharge_capacity','usable_capacity') %}
    #         {% set battery_used = states('sensor.daily_battery_use') %}
    #         {% set battery_dumped = states('sensor.daily_manual_battery_export') %}
    #         {% set solar_stored = states('sensor.daily_solar_stored') %}
    #         {% set L = states('input_number.solax_default_discharge_limit_soc') | float %}

    #         {# if ANY input or last value missing → return nothing, avoid spike #}
    #         {% if usable_capacity is none
    #               or battery_used in ['unknown','unavailable','none']
    #               or battery_dumped in ['unknown','unavailable','none']
    #               or solar_stored in ['unknown','unavailable','none'] %}
    #           {{ last }}
    #         {% else %}
    #           {% set usable_capacity = usable_capacity | float %}
    #           {% set battery_used = battery_used | float %}
    #           {% set battery_dumped = battery_dumped | float %}
    #           {% set solar_stored = solar_stored | float %}

    #           {% if usable_capacity == 0 %}
    #             {{ last }}
    #           {% else %}
    #             {# 1) compute SOC inside usable span 0–100 #}
    #             {% set soc_usable = 100 * ((usable_capacity - (battery_used + battery_dumped - solar_stored)) / usable_capacity) %}
    #             {% set soc_usable = [soc_usable, 100] | min %}
    #             {% set soc_usable = [soc_usable, 0] | max %}

    #             {# 2) map usable 0–100 → actual L–100 #}
    #             {% set soc = L + (soc_usable / 100) * (100 - L) %}

    #             {{ soc | int }}
    #           {% endif %}
    #         {% endif %}

    #       attributes:
    #         last_valid_soc: >
    #           {# --- same calculation for attribute --- #}
    #           {% set last = state_attr('sensor.alternative_solax_battery_soc','last_valid_soc') %}
    #           {% set usable_capacity = state_attr('sensor.solax_discharge_capacity','usable_capacity') %}
    #           {% set battery_used = states('sensor.daily_battery_use') %}
    #           {% set battery_dumped = states('sensor.daily_manual_battery_export') %}
    #           {% set solar_stored = states('sensor.daily_solar_stored') %}
    #           {% set L = states('input_number.solax_default_discharge_limit_soc') | float %}

    #           {# same logic: no value until everything is valid #}
    #           {% if usable_capacity is none
    #                 or battery_used in ['unknown','unavailable','none']
    #                 or battery_dumped in ['unknown','unavailable','none']
    #                 or solar_stored in ['unknown','unavailable','none'] %}
    #             {{ last }}
    #           {% else %}
    #             {% set usable_capacity = usable_capacity | float %}
    #             {% set battery_used = battery_used | float %}
    #             {% set battery_dumped = battery_dumped | float %}
    #             {% set solar_stored = solar_stored | float %}

    #             {# 1) calc SOC inside usable span #}
    #             {% set soc_usable = 100 * ((usable_capacity - (battery_used + battery_dumped - solar_stored)) / usable_capacity) %}
    #             {% set soc_usable = [soc_usable, 100] | min %}
    #             {% set soc_usable = [soc_usable, 0] | max %}

    #             {# 2) map usable 0–100 → actual L–100 #}
    #             {% set soc = L + (soc_usable / 100) * (100 - L) %}

    #             {{ soc | int }}
    #           {% endif %}

