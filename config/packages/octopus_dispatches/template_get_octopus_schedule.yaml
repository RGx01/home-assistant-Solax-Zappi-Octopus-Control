###############################################
#
# Change log
# v9.0.0 Finally fixed octopus_schedule_time...well.. I hope
# v8.0.0 octopus_schedule_time improved logic
# v6.0.0 Cleaned up and split into different template files
###############################################
octopus_dispatches_template_get_octopus_schedule:
  template:
    ######################################################
    # Wobble
    ######################################################
    - trigger:
        - trigger: time
          at: "01:00:00"
      sensor:
        - name: "Wobble"
          unique_id: wobble
          state: >
            {{range(1, 30)|random}}

    ######################################################
    # EV Start Time + Wobble
    ######################################################
    - sensor:
        - name: Don't Charge EV before time (wobble)
          unique_id: don_t_charge_ev_before_time_wobble
          device_class: "timestamp"
          state: >
            {% set td = timedelta(days=10) %}
            {% set wobble = states('sensor.wobble')|int(0) %}
            {# set wobble = 0 #}
            {% set input_time = states('input_datetime.don_t_charge_ev_before_time') %}
            {% set base = now() %}
            {% if input_time not in ['unknown','unavailable',''] %}
              {% set base = today_at(input_time) %}
            {% endif %}
            {% set ts = base | as_timestamp + wobble*60 %}
            {% set dt = ts | as_datetime |as_local %}
            {{ dt.isoformat() if dt else (now() + td).isoformat() }}
    ######################################################
    # Earliest EV Start Time
    ######################################################
    - sensor:
        - name: Earliest EV Charge Start Time
          unique_id: earliest_ev_charge_start_time
          device_class: "timestamp"
          state: >
            {% set target_time = states('sensor.octopus_intelligent_target_time')|as_timestamp (default=today_at("05:30")|as_timestamp)%}
            {% set target_percentage = states('number.octopus_intelligent_charge_target')|int (default=100) %}
            {% set ev_size = states('input_number.ev_battery_size')|int(default=10) %}
            {% set delta_time = ((ev_size|int/6.8)*(target_percentage|int/100))*60*60%}
            {{(target_time-delta_time)|as_datetime (default=(now()|as_timestamp-delta_time)|as_datetime)}}
    ######################################################
    # Solar threshold calcs
    # elevation - is degrees the sun is above the horizon
    ######################################################
    - sensor:
        - name: Solar Export Threshold
          unique_id: solar_export_threshold
          device_class: "timestamp"
          icon: mdi:weather-sunset-down
          state: >
            {% set utc_offset = now().utcoffset().total_seconds() / 3600 %}
            {% set year = now().year -%}
            {% set month = now().month -%}
            {% set day = now().day -%}
            {% set longitude = state_attr('zone.home','longitude')|float -%}
            {% set latitude = state_attr('zone.home','latitude')|float -%}
            {% set elevation = states('input_number.sun_degrees_above_horizon')|float -%}
            {% set JD = (367 * year) - ((7 * (year + ((month + 9) // 12))) // 4) + ((275 * month) // 9) + day + 1721014 -%}
            {% set JC = (JD - 2451545) / 36525 %}
            {% set Geom_Mean_Long_Sun_deg = (280.46646+JC*(36000.76983+JC*0.0003032)) %360 -%}
            {% set Geom_Mean_Anom_Sun_deg = 357.52911+JC*(35999.05029-0.0001537*JC) -%}
            {% set Eccent_Earth_Orbit= 0.016708634-JC*(0.000042037+0.0000001267*JC) -%}
            {% set Sun_Eq_of_Ctr = sin(Geom_Mean_Anom_Sun_deg*pi/180)*(1.914602-JC*(0.004817+0.000014*JC))+sin(2*Geom_Mean_Anom_Sun_deg*pi/180)*(0.019993-0.000101*JC)+sin(3*Geom_Mean_Anom_Sun_deg*pi/180)*0.000289 -%}
            {% set Sun_True_Long_deg = Geom_Mean_Long_Sun_deg + Sun_Eq_of_Ctr -%}
            {% set Sun_True_Anom_deg = Geom_Mean_Anom_Sun_deg + Sun_Eq_of_Ctr -%}
            {% set Sun_Rad_Vector_AUs = (1.000001018*(1-Eccent_Earth_Orbit*Eccent_Earth_Orbit))/(1+Eccent_Earth_Orbit*cos(Sun_True_Anom_deg*pi/180)) -%}
            {% set Sun_App_Long_deg = Sun_True_Long_deg-0.00569-0.00478*sin((125.04-1934.136*JC)*pi/180) -%}
            {% set Mean_Obliq_Ecliptic_deg = 23+(26+((21.448-JC*(46.815+JC*(0.00059-JC*0.001813))))/60)/60 -%}
            {% set Obliq_Corr_deg = Mean_Obliq_Ecliptic_deg+0.00256*cos((125.04-1934.136*JC)*pi/180) -%}
            {% set Sun_Rt_Ascen_deg = (atan2(cos((Obliq_Corr_deg)*pi/180)*sin((Sun_App_Long_deg)*pi/180),cos((Sun_App_Long_deg)*pi/180)))*180/pi -%}
            {% set Sun_Declin_deg = (asin(sin((Obliq_Corr_deg)*pi/180)*sin((Sun_App_Long_deg)*pi/180)))*180/pi -%}
            {% set Var_Y = tan((Obliq_Corr_deg/2)*pi/180)*tan((Obliq_Corr_deg/2)*pi/180) -%}
            {% set Eq_of_Time_minutes = 4*180/pi*(Var_Y*sin(2*(Geom_Mean_Long_Sun_deg)*pi/180)-2*Eccent_Earth_Orbit*sin((Geom_Mean_Anom_Sun_deg)*pi/180)+4*Eccent_Earth_Orbit*Var_Y*sin((Geom_Mean_Anom_Sun_deg)*pi/180)*cos(2*(Geom_Mean_Long_Sun_deg)*pi/180)-0.5*Var_Y*Var_Y*sin(4*(Geom_Mean_Long_Sun_deg)*pi/180)-1.25*Eccent_Earth_Orbit*Eccent_Earth_Orbit*sin(2*(Geom_Mean_Anom_Sun_deg)*pi/180)) -%}
            {% set HA_Sunrise_deg = 180/pi*(acos((sin((elevation)*pi/180) - sin((latitude)*pi/180) * sin((Sun_Declin_deg)*pi/180)) / (cos((latitude)*pi/180) * cos((Sun_Declin_deg)*pi/180)))) -%}
            {% set Solar_Noon_LST = (720-4*longitude-Eq_of_Time_minutes+utc_offset*60)/1440 -%}
            {% set Sunrise_Time_LST = (Solar_Noon_LST*1440-HA_Sunrise_deg*4)/1440 -%}
            {% set Sunset_Time_LST = (Solar_Noon_LST*1440+HA_Sunrise_deg*4)/1440 -%}
            {% set Sunlight_Duration_minutes = 8*HA_Sunrise_deg -%}
            {% set True_Solar_Time_min = (0.5*1440+Eq_of_Time_minutes+4*longitude-60*utc_offset)%1440 -%}
            {% if True_Solar_Time_min/4 <0 -%}
              {% set Hour_Angle_deg = True_Solar_Time_min/4+180 -%}
            {% else -%}
              {% set Hour_Angle_deg = True_Solar_Time_min/4-180 -%}
            {% endif -%}
            {% set Sunset_time_UTC = Sunset_Time_LST*24 -%}
            {% set sunset_hour = Sunset_time_UTC | int -%}
            {% set sunset_minute = ((Sunset_time_UTC * 60) % 60) | int -%}
            {% set sunset_second = (((Sunset_time_UTC * 60 * 60) % 60) % 60) | int -%}
            {% set local_sunset_time = now().replace(hour=sunset_hour, minute=sunset_minute, second=sunset_second, microsecond=0)|as_datetime|as_local -%}
            {% set local_sunset_time2 = sunset_hour|string +':'+ sunset_minute|string  -%}
            {{ local_sunset_time.isoformat() if local_sunset_time else (now() + timedelta(days=10)) | as_local | isoformat }}

    # =====================================================
    # Now 189 Thats what I call Jinja
    # 1. What is love?
    # 2. Jinja don't hurt me (no more)
    # 3. What else can I say?
    # 4. It's up to you.....
    # =====================================================
    # =====================================================
    # Smart Charge Time Sensor â€“ Behaviour Spec
    # =====================================================
    #
    # Modes:
    #   anytime_p       : 'Octopus Schedule Anytime'
    #   solar_p         : 'Solar Export Priority'
    #   fixed_p         : 'Fixed Time'
    #   default         : no mode selected
    #
    # Logic:
    #   1. anytime_p:
    #        - Timestamp only leaps forward in two cases:
    #            a) EV initially becomes connected
    #            b) Mode switches to anytime_p
    #        - Otherwise, previous lock is retained to prevent "minute creep"
    #
    #   2. solar_p:
    #        - base_time = max(default_solar, last_conn_plus, prev_solar_locked)
    #            default_solar      : current solar export threshold
    #            last_conn_plus     : EV connection time + delay (if connected)
    #            prev_solar_locked  : previous solar lock snapshot
    #        - Ensures timestamp only moves forward, never backward
    #        - Solar scenarios:
    #            - EV connects before threshold:
    #                timestamp = threshold
    #            - EV connects after threshold:
    #                timestamp = connection + delay
    #            - Mode switch to solar, EV already connected before threshold:
    #                timestamp = threshold
    #            - Mode switch to solar, EV already connected after threshold:
    #                timestamp = connection + delay
    #            - Mode switch to solar, EV disconnected before threshold:
    #                timestamp = threshold
    #            - Mode switch to solar, EV disconnected after threshold:
    #                timestamp = previous lock or threshold
    #            - Solar threshold recalculated:
    #                timestamp = max(new threshold, last_conn_plus, prev_solar_locked)
    #
    #   3. fixed_p:
    #        - Behaves similarly to solar_p
    #        - base_time = max(default_fixed, last_conn_plus, prev_fixed_locked)
    #        - Ensures timestamp only moves forward
    #        - Scenarios mirror solar_p logic, replacing threshold with fixed time
    #
    #   4. default (no mode):
    #        - base_time = now_local + 10 days
    #        - Used as a safe fallback
    #
    # Notes:
    #   - Delay after EV connection is always respected for anytime_p, solar_p, fixed_p
    #   - Timestamp never moves backward
    #   - The snapshots attribute stores last locked times for all modes
    # =====================================================
    - sensor:
        - name: "Smart Charge Time"
          unique_id: octopus_schedule_time
          device_class: timestamp

          state: >
            {% set now_local = now() | as_local %}
            {% set now_local = now_local.replace(second=0, microsecond=0) %}
            {% set delay = states('input_number.delay_when_ev_connected') | float(0) %}

            {# Mode toggles #}
            {% set anyt = is_state('input_boolean.octopus_schedule_anytime','on') %}
            {% set solar_p = is_state('input_boolean.solar_export_priority','on') %}
            {% set fixed_p = is_state('input_boolean.use_fixed_time','on') %}

            {# EV connection times #}
            {% set conn_raw = states('sensor.zappi_last_connected') %}
            {% set disc_raw = states('sensor.zappi_last_disconnected') %}
            {% set conn = (conn_raw | as_datetime | as_local) if conn_raw not in ['unknown','unavailable','none',''] else none %}
            {% set disc = (disc_raw | as_datetime | as_local) if disc_raw not in ['unknown','unavailable','none',''] else none %}
            {% set is_connected = conn and (not disc or conn > disc) %}
            {% set last_conn_plus = conn + timedelta(minutes=delay) if conn else none %}

            {# Previous snapshots #}
            {% set prev_snap_raw = state_attr('sensor.octopus_schedule_time','snapshots') %}
            {% if prev_snap_raw in [None,'','unknown'] %}
              {% set prev_snap = {} %}
            {% elif prev_snap_raw is string %}
              {% set prev_snap = (prev_snap_raw | from_json) if prev_snap_raw | trim != '' else {} %}
            {% else %}
              {% set prev_snap = prev_snap_raw %}
            {% endif %}

            {% set prev_anyt_locked = (prev_snap.get('anytime', {}).get('locked') | as_datetime | as_local)
                if prev_snap.get('anytime', {}).get('locked') not in [None,'','unknown'] else none %}
            {% set prev_anyt_mode = prev_snap.get('anytime', {}).get('anyt', false) %}
            {% set prev_anyt_connected = prev_snap.get('anytime', {}).get('is_connected', false) %}

            {# Solar fallback #}
            {% set solar_raw = states('sensor.solar_export_threshold') %}
            {% set default_solar = solar_raw | as_datetime | as_local
                if solar_raw not in ['unknown','unavailable','none',''] else none %}
            {% set prev_solar_locked = (
                  prev_snap.get('solar', {}).get('locked') | as_datetime | as_local
                ) if prev_snap.get('solar', {}).get('locked') not in [None,'','unknown']
                else default_solar %}

            {# Fixed fallback #}
            {% set fixed_raw_from_state = states('sensor.don_t_charge_ev_before_time_wobble') %}
            {% set default_fixed = fixed_raw_from_state | as_datetime | as_local
                if fixed_raw_from_state not in ['unknown','unavailable','none',''] else none %}
            {% set prev_fixed_locked = (
                  prev_snap.get('fixed', {}).get('locked') | as_datetime | as_local
                ) if prev_snap.get('fixed', {}).get('locked') not in [None,'','unknown']
                else default_fixed %}

            {# ============================
              MAIN MODE SELECTION BLOCK
              ============================ #}

            {% if anyt %}

              {# Only leap forward if mode just enabled OR EV just connected #}
              {% set anytime_just_enabled = anyt and not prev_anyt_mode %}
              {% set ev_just_connected = is_connected and not prev_anyt_connected %}

              {% if prev_anyt_locked and prev_anyt_locked > now_local %}
                  {% set base_time = prev_anyt_locked %}
              {% elif anytime_just_enabled or ev_just_connected %}
                  {% set base_time = now_local + timedelta(minutes=delay) %}
              {% else %}
                  {% set base_time = prev_anyt_locked if prev_anyt_locked else now_local + timedelta(minutes=delay) %}
              {% endif %}

            {% elif solar_p %}
              {# Solar Mode #}
              {% set base_time = [default_solar, last_conn_plus, prev_solar_locked] | select('!=',none) | list | max %}

            {% elif fixed_p %}
              {# Fixed Mode #}
              {% set base_time = [default_fixed, last_conn_plus, prev_fixed_locked] | select('!=',none) | list | max %}

            {% else %}
              {# Default fallback #}
              {% set base_time = now_local + timedelta(days=10) %}
            {% endif %}

            {{ base_time.replace(second=0, microsecond=0) }}

          attributes:
            snapshots: >
              {% set now_local = now() | as_local %}
              {% set now_local = now_local.replace(second=0, microsecond=0) %}
              {% set delay = states('input_number.delay_when_ev_connected') | float(0) %}

              {# Mode toggles #}
              {% set anyt = is_state('input_boolean.octopus_schedule_anytime','on') %}
              {% set solar_p = is_state('input_boolean.solar_export_priority','on') %}
              {% set fixed_p = is_state('input_boolean.use_fixed_time','on') %}

              {# EV connection times #}
              {% set conn_raw = states('sensor.zappi_last_connected') %}
              {% set disc_raw = states('sensor.zappi_last_disconnected') %}
              {% set conn = (conn_raw | as_datetime | as_local) if conn_raw not in ['unknown','unavailable','none',''] else none %}
              {% set disc = (disc_raw | as_datetime | as_local) if disc_raw not in ['unknown','unavailable','none',''] else none %}
              {% set is_connected = conn and (not disc or conn > disc) %}
              {% set last_conn_plus = conn + timedelta(minutes=delay) if conn else none %}

              {# Previous snapshots #}
              {% set prev_snap_raw = state_attr('sensor.octopus_schedule_time','snapshots') %}
              {% if prev_snap_raw in [None,'','unknown'] %}
                {% set prev_snap = {} %}
              {% elif prev_snap_raw is string %}
                {% set prev_snap = (prev_snap_raw | from_json) if prev_snap_raw | trim != '' else {} %}
              {% else %}
                {% set prev_snap = prev_snap_raw %}
              {% endif %}

              {% set prev_anyt_locked = (prev_snap.get('anytime', {}).get('locked') | as_datetime | as_local)
                  if prev_snap.get('anytime', {}).get('locked') not in [None,'','unknown'] else none %}
              {% set prev_anyt_mode = prev_snap.get('anytime', {}).get('anyt', false) %}
              {% set prev_anyt_connected = prev_snap.get('anytime', {}).get('is_connected', false) %}

              {# Solar snapshot #}
              {% set solar_raw = states('sensor.solar_export_threshold') %}
              {% set default_solar = solar_raw | as_datetime | as_local
                  if solar_raw not in ['unknown','unavailable','none',''] else none %}
              {% set prev_solar_locked = (
                    prev_snap.get('solar', {}).get('locked') | as_datetime | as_local
                  ) if prev_snap.get('solar', {}).get('locked') not in [None,'','unknown']
                  else default_solar %}

              {# Fixed snapshot #}
              {% set fixed_raw_from_state = states('sensor.don_t_charge_ev_before_time_wobble') %}
              {% set default_fixed = fixed_raw_from_state | as_datetime | as_local
                  if fixed_raw_from_state not in ['unknown','unavailable','none',''] else none %}
              {% set prev_fixed_locked = (
                    prev_snap.get('fixed', {}).get('locked') | as_datetime | as_local
                  ) if prev_snap.get('fixed', {}).get('locked') not in [None,'','unknown']
                  else default_fixed %}

              {# Anytime snapshot #}
              {% set anytime_just_enabled = anyt and not prev_anyt_mode %}
              {% set ev_just_connected = is_connected and not prev_anyt_connected %}
              {% if prev_anyt_locked and prev_anyt_locked > now_local %}
                {% set locked_anytime = prev_anyt_locked %}
              {% elif anytime_just_enabled or ev_just_connected %}
                {% set locked_anytime = now_local + timedelta(minutes=delay) %}
              {% else %}
                {% set locked_anytime = prev_anyt_locked if prev_anyt_locked else now_local + timedelta(minutes=delay) %}
              {% endif %}

              {# Solar snapshot #}
              {% set locked_solar = [default_solar, last_conn_plus, prev_solar_locked] | select('!=',none) | list | max %}

              {# Fixed snapshot #}
              {% set locked_fixed = [default_fixed, last_conn_plus, prev_fixed_locked] | select('!=',none) | list | max %}

              {{
                {
                  "anytime": {
                    "locked": (locked_anytime | string),
                    "anyt": anyt,
                    "is_connected": is_connected
                  },
                  "solar": {
                    "locked": (locked_solar | string),
                    "solar_p": solar_p
                  },
                  "fixed": {
                    "locked": (locked_fixed | string),
                    "fixed_p": fixed_p
                  }
                } | to_json
              }}
