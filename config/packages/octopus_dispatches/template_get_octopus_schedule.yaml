###############################################
#
# Change log
# v8.0.0 octopus_schedule_time improved logic
# v6.0.0 Cleaned up and split into different template files
###############################################
octopus_dispatches_template_get_octopus_schedule:
  template:
    ######################################################
    # Wobble
    ######################################################
    - trigger:
        - trigger: time
          at: "01:00:00"
      sensor:
        - name: "Wobble"
          unique_id: wobble
          state: >
            {{range(1, 30)|random}}

    ######################################################
    # EV Start Time + Wobble
    ######################################################
    - sensor:
        - name: Don't Charge EV before time (wobble)
          unique_id: don_t_charge_ev_before_time_wobble
          device_class: "timestamp"
          state: >
            {% set td = timedelta(days=10) %}
            {% set wobble = states('sensor.wobble')|int(0) %}
            {# set wobble = 0 #}
            {% set input_time = states('input_datetime.don_t_charge_ev_before_time') %}
            {% set base = now() %}
            {% if input_time not in ['unknown','unavailable',''] %}
              {% set base = today_at(input_time) %}
            {% endif %}
            {% set ts = base | as_timestamp + wobble*60 %}
            {% set dt = ts | as_datetime |as_local %}
            {{ dt.isoformat() if dt else (now() + td).isoformat() }}
    ######################################################
    # Earliest EV Start Time
    ######################################################
    - sensor:
        - name: Earliest EV Charge Start Time
          unique_id: earliest_ev_charge_start_time
          device_class: "timestamp"
          state: >
            {%set target_time = states('sensor.octopus_intelligent_target_time')|as_timestamp (default=today_at("05:30")|as_timestamp)%}
            {%set target_percentage = states('number.octopus_intelligent_charge_target')|int (default=100) %}
            {%set ev_size = states('input_number.ev_battery_size')|int(default=10) %}
            {%set delta_time = ((ev_size|int/6.8)*(target_percentage|int/100))*60*60%}
            {{(target_time-delta_time)|as_datetime (default=(now()|as_timestamp-delta_time)|as_datetime)}}
    ######################################################
    # Solar threshold calcs
    # elevation - is degrees the sun is above the horizon
    ######################################################
    - sensor:
        - name: Solar Export Threshold
          unique_id: solar_export_threshold
          device_class: "timestamp"
          icon: mdi:weather-sunset-down
          state: >
            {% set utc_offset = now().utcoffset().total_seconds() / 3600 %}
            {% set year = now().year -%}
            {% set month = now().month -%}
            {% set day = now().day -%}
            {% set longitude = state_attr('zone.home','longitude')|float -%}
            {% set latitude = state_attr('zone.home','latitude')|float -%}
            {% set elevation = states('input_number.sun_degrees_above_horizon')|float -%}
            {% set JD = (367 * year) - ((7 * (year + ((month + 9) // 12))) // 4) + ((275 * month) // 9) + day + 1721014 -%}
            {% set JC = (JD - 2451545) / 36525 %}
            {% set Geom_Mean_Long_Sun_deg = (280.46646+JC*(36000.76983+JC*0.0003032)) %360 -%}
            {% set Geom_Mean_Anom_Sun_deg = 357.52911+JC*(35999.05029-0.0001537*JC) -%}
            {% set Eccent_Earth_Orbit= 0.016708634-JC*(0.000042037+0.0000001267*JC) -%}
            {% set Sun_Eq_of_Ctr = sin(Geom_Mean_Anom_Sun_deg*pi/180)*(1.914602-JC*(0.004817+0.000014*JC))+sin(2*Geom_Mean_Anom_Sun_deg*pi/180)*(0.019993-0.000101*JC)+sin(3*Geom_Mean_Anom_Sun_deg*pi/180)*0.000289 -%}
            {% set Sun_True_Long_deg = Geom_Mean_Long_Sun_deg + Sun_Eq_of_Ctr -%}
            {% set Sun_True_Anom_deg = Geom_Mean_Anom_Sun_deg + Sun_Eq_of_Ctr -%}
            {% set Sun_Rad_Vector_AUs = (1.000001018*(1-Eccent_Earth_Orbit*Eccent_Earth_Orbit))/(1+Eccent_Earth_Orbit*cos(Sun_True_Anom_deg*pi/180)) -%}
            {% set Sun_App_Long_deg = Sun_True_Long_deg-0.00569-0.00478*sin((125.04-1934.136*JC)*pi/180) -%}
            {% set Mean_Obliq_Ecliptic_deg = 23+(26+((21.448-JC*(46.815+JC*(0.00059-JC*0.001813))))/60)/60 -%}
            {% set Obliq_Corr_deg = Mean_Obliq_Ecliptic_deg+0.00256*cos((125.04-1934.136*JC)*pi/180) -%}
            {% set Sun_Rt_Ascen_deg = (atan2(cos((Obliq_Corr_deg)*pi/180)*sin((Sun_App_Long_deg)*pi/180),cos((Sun_App_Long_deg)*pi/180)))*180/pi -%}
            {% set Sun_Declin_deg = (asin(sin((Obliq_Corr_deg)*pi/180)*sin((Sun_App_Long_deg)*pi/180)))*180/pi -%}
            {% set Var_Y = tan((Obliq_Corr_deg/2)*pi/180)*tan((Obliq_Corr_deg/2)*pi/180) -%}
            {% set Eq_of_Time_minutes = 4*180/pi*(Var_Y*sin(2*(Geom_Mean_Long_Sun_deg)*pi/180)-2*Eccent_Earth_Orbit*sin((Geom_Mean_Anom_Sun_deg)*pi/180)+4*Eccent_Earth_Orbit*Var_Y*sin((Geom_Mean_Anom_Sun_deg)*pi/180)*cos(2*(Geom_Mean_Long_Sun_deg)*pi/180)-0.5*Var_Y*Var_Y*sin(4*(Geom_Mean_Long_Sun_deg)*pi/180)-1.25*Eccent_Earth_Orbit*Eccent_Earth_Orbit*sin(2*(Geom_Mean_Anom_Sun_deg)*pi/180)) -%}
            {% set HA_Sunrise_deg = 180/pi*(acos((sin((elevation)*pi/180) - sin((latitude)*pi/180) * sin((Sun_Declin_deg)*pi/180)) / (cos((latitude)*pi/180) * cos((Sun_Declin_deg)*pi/180)))) -%}
            {% set Solar_Noon_LST = (720-4*longitude-Eq_of_Time_minutes+utc_offset*60)/1440 -%}
            {% set Sunrise_Time_LST = (Solar_Noon_LST*1440-HA_Sunrise_deg*4)/1440 -%}
            {% set Sunset_Time_LST = (Solar_Noon_LST*1440+HA_Sunrise_deg*4)/1440 -%}
            {% set Sunlight_Duration_minutes = 8*HA_Sunrise_deg -%}
            {% set True_Solar_Time_min = (0.5*1440+Eq_of_Time_minutes+4*longitude-60*utc_offset)%1440 -%}
            {% if True_Solar_Time_min/4 <0 -%}
              {% set Hour_Angle_deg = True_Solar_Time_min/4+180 -%}
            {% else -%}
              {% set Hour_Angle_deg = True_Solar_Time_min/4-180 -%}
            {% endif -%}
            {% set Sunset_time_UTC = Sunset_Time_LST*24 -%}
            {% set sunset_hour = Sunset_time_UTC | int -%}
            {% set sunset_minute = ((Sunset_time_UTC * 60) % 60) | int -%}
            {% set sunset_second = (((Sunset_time_UTC * 60 * 60) % 60) % 60) | int -%}
            {% set local_sunset_time = now().replace(hour=sunset_hour, minute=sunset_minute, second=sunset_second, microsecond=0)|as_datetime|as_local -%}
            {% set local_sunset_time2 = sunset_hour|string +':'+ sunset_minute|string  -%}
            {{ local_sunset_time.isoformat() if local_sunset_time else (now() + timedelta(days=10)) | as_local | isoformat }}

    - sensor:
        - name: "Smart Charge Time"
          unique_id: octopus_schedule_time
          device_class: timestamp

          state: >
            {% set free    = states('sensor.octopus_free_electricity_start') %}
            {% set free_p  = is_state('binary_sensor.free_electricity_today', 'on') %}

            {% set solar   = states('sensor.solar_export_threshold') %}
            {% set solar_p = is_state('input_boolean.solar_export_priority', 'on') %}

            {% set fixed   = states('sensor.don_t_charge_ev_before_time_wobble') %}
            {% set fixed_p = is_state('input_boolean.use_fixed_time','on') %}

            {% set anyt    = is_state('input_boolean.octopus_schedule_anytime', 'on') %}

            {% set conn    = states('sensor.zappi_last_connected') %}
            {% set disc    = states('sensor.zappi_last_disconnected') %}
            {% set delay   = states('input_number.delay_when_ev_connected') | float(0) %}

            {% set now_local = now() | as_local %}

            {# Parse datetimes #}
            {% set conn_dt = conn | as_datetime | as_local
                  if conn not in ['unknown','unavailable','none'] else None %}
            {% set disc_dt = disc | as_datetime | as_local
                  if disc not in ['unknown','unavailable','none'] else None %}

            {# Connection state #}
            {% set is_connected =
                  conn_dt is not none and
                  (disc_dt is none or conn_dt > disc_dt)
            %}

            {# Load previous timestamp (for freeze) #}
            {% set prev = states('sensor.octopus_schedule_time') %}
            {% set prev_dt = prev | as_datetime | as_local
                if prev not in ['unknown','unavailable','none'] else None %}

            {# Load stored snapshot #}
            {% set snap_raw = state_attr('sensor.octopus_schedule_time','anytime_snapshot') %}
            {% if snap_raw is string %}
              {% set snapshot = snap_raw | from_json %}
            {% else %}
              {% set snapshot = snap_raw %}
            {% endif %}

            {# Current snapshot candidate #}
            {% set new_snapshot = {
              "anyt": anyt,
              "is_connected": is_connected,
              "conn_dt": conn_dt|string,
              "delay": delay,
              "free": free,
              "solar": solar,
              "fixed": fixed
            } %}

            {# Determine if recalculation is needed #}
            {% set recalc_needed =
                snapshot is none
                or snapshot.anyt != new_snapshot.anyt
                or snapshot.is_connected != new_snapshot.is_connected
                or snapshot.conn_dt != new_snapshot.conn_dt
                or snapshot.delay != new_snapshot.delay
                or snapshot.free != new_snapshot.free
                or snapshot.solar != new_snapshot.solar
                or snapshot.fixed != new_snapshot.fixed
            %}

            {# If NOT anytime -> always recalc #}
            {% if not anyt %}
              {% set recalc_needed = true %}
            {% endif %}

            {# ------------- RECALC BRANCH ------------- #}
            {% if recalc_needed %}

              {% if free_p and free not in ['unknown','unavailable','none'] %}
                {% set base_time = free | as_datetime | as_local %}

              {% elif not anyt and solar_p and solar not in ['unknown','unavailable','none'] and not fixed_p %}
                {% set base_time = solar | as_datetime | as_local %}

              {% elif not anyt and fixed_p and fixed not in ['unknown','unavailable','none'] %}
                {% set base_time = fixed | as_datetime | as_local %}

              {% elif anyt %}
                {# ------------ ANYTIME MODE LOGIC ------------ #}

                {% if is_connected %}
                  {# If anytime was just turned on → use now + delay #}
                  {% if snapshot is none or snapshot.anyt != anyt %}
                    {% set base_time = now_local + timedelta(minutes=delay) %}
                  {% else %}
                    {# Normal anytime behaviour → conn_dt + delay #}
                    {% set base_time = conn_dt + timedelta(minutes=delay) %}
                  {% endif %}
                {% else %}
                  {# Not connected → schedule disabled placeholder #}
                  {% set base_time = now_local + timedelta(days=10) %}
                {% endif %}

              {% else %}
                {# No valid mode → push far into future #}
                {% set base_time = now_local + timedelta(days=10) %}
              {% endif %}

            {% else %}
              {# ------------ FREEZE BRANCH ------------ #}
              {% set base_time = prev_dt %}
            {% endif %}

            {{ base_time }}

          attributes:
            anytime_snapshot: >
              {% set free    = states('sensor.octopus_free_electricity_start') %}
              {% set solar   = states('sensor.solar_export_threshold') %}
              {% set fixed   = states('sensor.don_t_charge_ev_before_time_wobble') %}
              {% set anyt    = is_state('input_boolean.octopus_schedule_anytime', 'on') %}
              {% set conn    = states('sensor.zappi_last_connected') %}
              {% set disc    = states('sensor.zappi_last_disconnected') %}
              {% set delay   = states('input_number.delay_when_ev_connected') | float(0) %}

              {% set conn_dt = conn | as_datetime | as_local
                    if conn not in ['unknown','unavailable','none'] else None %}
              {% set disc_dt = disc | as_datetime | as_local
                    if disc not in ['unknown','unavailable','none'] else None %}
              {% set now_local = now() | as_local %}
              {% set is_connected =
                    conn_dt is not none and
                    (disc_dt is none or conn_dt > disc_dt)
              %}

              {{
                {
                  "anyt": anyt,
                  "is_connected": is_connected,
                  "conn_dt": conn_dt|string,
                  "disc_dt": disc_dt|string,
                  "delay": delay,
                  "free": free,
                  "solar": solar,
                  "fixed": fixed
                } | to_json
              }}
