octopus_dispatches_template_hh_offpeak:
  template:
    # ############################################################################
    # Sensor: Octopus Energy Electricity Off Peak Companion
    # Unique ID: octopus_energy_electricity_off_peak_companion
    #
    # Purpose:
    # This binary sensor indicates whether we are in an HH slot that is off peak with sufficient
    # time left available to be useful for load shift based on Octopus off-peak periods, EV charging, 
    # and configurable delta time thresholds.
    #
    # Requirements / Behavior:
    # 1. **Static Off-Peak Window**
    #    - Defined by OFF_PEAK_START and OFF_PEAK_END (e.g., 23:00–05:30)
    #    - Can be enabled/disabled using STATIC_OFF_PEAK_ENABLED
    #    - When enabled, sensor turns ON for the entire static window
    #
    # 2. **EV Slot Eligibility**
    #    - EV charging detected via sensor.zappi_plug_status == "Charging"
    #    - Bleed-in period (BLEED_OVER_MINUTES) ensures short leftover charges
    #    - Minimum remaining slot time (WORTH_IT_MINUTES) ensures worthwhile energy use
    #    - Half-hour slots (HH:00–HH:29, HH:30–HH:59)
    #    - If EV meets criteria, the slot is eligible
    #
    # 3. **Octopus off-peak Confirmation**
    #    - binary_sensor.octopus_energy_electricity_off_peak must be ON
    #    - Due to API lag, Octopus confirmation is ignored until
    #      OCTOPUS_GRACE_MINUTES into the current HH slot
    #    - Ensures no false positives due to previous HH "bleed-over"
    #
    # 4. **Stateless Latching**
    #    - Once a slot is confirmed (EV eligible + Octopus confirmed),
    #      sensor stays ON until the end of the HH slot
    #    - prev_state is used to latch without helpers or automations
    #    - Latch resets automatically at the start of the next slot
    #
    # 5. **Attributes**
    #    - hh_start / hh_end: Start and end of current half-hour slot
    #    - octopus_last_on_hh: Last HH slot where Octopus sensor was ON
    #    - slot_ev_eligible: Whether EV criteria are met for this slot
    #    - slot_blocked_by_octopus: EV criteria met, but Octopus not yet confirmed
    #    - sensor_latched_at: timestamp when this sensor latched ON
    #
    # 6. **Behavior Summary**
    #    - Sensor only turns ON if EV slot is eligible and Octopus confirms the slot is eligible
    #    - The 2-minute grace period ensures the eligibility of the HH for off-peak, 
    #      so the beginning of an HH will always start OFF, even during a contiguous/continuous charge
    #    - Latches ON for the remainder of the HH slot once confirmed
    #    - Static off-peak window overrides EV/Octopus if enabled
    #    - Prevents false ON at HH transitions due to any API lag
    #
    # 7. **Contiguous HH Mode (Optional)**
    #    - When enabled, allows the sensor to remain ON across HH boundaries only at the start of a new HH
    #    - A contiguous bridge is allowed if:
    #      - The previous HH was off-peak either because:
    #        - The companion sensor was ON in the previous HH, or
    #        - The previous HH was entirely within the static off-peak window and the Octopus sensor was ON at the end of that HH
    #      - Octopus sensor remains ON
    #      - The current time is within OCTOPUS_GRACE_MINUTES
    #
    # 8. **Strongly Recommend**
    #    - Sensors used for OCTOPUS_ON and EV_CHARGING should be suitably hardened against API drop outs and HA restarts or template reloads. 
    # ############################################################################
    # v10.4.0 improved 5:30 am exit if static off peak is false
    - binary_sensor:
        - name: "Octopus Energy Electricity Off Peak Companion"
          unique_id: octopus_energy_electricity_off_peak_companion

          state: >
            {# ================== PARAMETERS ================== #}
            {# set OFF_PEAK_START = "23:00" %}
            {# set OFF_PEAK_END   = "05:30" %}
            {# set STATIC_OFF_PEAK_ENABLED = false %} {# Set false and static offpeak times will report false (this is useful if you only want to report on during peak time dispatches). Set to true and static offpeak hours will report as on #}
            {# set BLEED_OVER_MINUTES  = 4 %} {# minutes of ignored ev charging at beginning of HH when not in contigious mode #}
            {# set WORTH_IT_MINUTES  = 15 %} {# Minimum minutes of remaining slot time required to first turn ON sensor #}
            {# set OCTOPUS_GRACE_MINUTES = 2 %} {#Grace period in minutes at the beginning of HH where octopus sensor can switch off and sensor will follow #}
            {# set CONTIGUOUS_HH_MODE = true %} {# set to true for a more risky approach to crossing into the next HH (if previous HH was on). If your peak rate sensor is still on after the grace period then the whole HH is assumed to be offpeak #}

            {% set OFF_PEAK_START = states('input_select.slot_end') %} {# "23:30" input_select is reused from battery reserves so start/end appear reversed #}
            {% set OFF_PEAK_END   = states('input_select.slot_start') %} {# "05:30" #}
            {% set STATIC_OFF_PEAK_ENABLED = false %} {# is_state('input_boolean.companion_charging_during_off_peak','on')  %} {# Set false and static offpeak times will report false (this is useful if you only want to report on during peak time dispatches). Set to true and static offpeak hours will report as on #}
            {% set BLEED_OVER_MINUTES  = 4 %} {# minutes of ignored ev charging at beginning of HH when not in contigious mode #}
            {% set WORTH_IT_MINUTES  = 15 %} {# Minimum minutes of remaining slot time required to first turn ON sensor #}
            {% set OCTOPUS_GRACE_MINUTES = 2 %} {#Grace period in minutes at the beginning of HH where octopus sensor can switch off and sensor will follow #}
            {% set CONTIGUOUS_HH_MODE = is_state('input_boolean.companion_charging_contiguous_mode','on') %} {# set to true for a more risky approach to crossing into the next HH (if previous HH was on). If your peak rate sensor is still on after the grace period then the whole HH is assumed to be offpeak #}

            {% set OCTOPUS_ON = is_state('binary_sensor.octopus_intelligent_dispatching','on') %} {# <-- YOUR OCTOPUS OFFPEAK SENSOR GOES HERE. Check attributes below too #}
            {% set EV_CHARGING = states('sensor.zappi_plug_status') == 'Charging' %} {# <-- YOUR EV IS ChARGING SENSOR GOES HERE. Check attributes below too #}
            {# ================================================== #}

            {% set now_ts = now() %}
            {% set now_min = now_ts.hour * 60 + now_ts.minute %}
            {% set prev_state = is_state(
                'binary_sensor.octopus_energy_electricity_off_peak_companion',
                'on'
            ) %}

            {# ---- Current HH slot ---- #}
            {% set slot_start_minute = 0 if now_ts.minute < 30 else 30 %}
            {% set minutes_into_slot = now_ts.minute - slot_start_minute %}
            {% set minutes_remaining = 30 - minutes_into_slot %}

            {# ---- Static off-peak ---- #}
            {% set start_min =
                OFF_PEAK_START[0:2]|int * 60 + OFF_PEAK_START[3:5]|int %}
            {% set end_min =
                OFF_PEAK_END[0:2]|int * 60 + OFF_PEAK_END[3:5]|int %}

            {% set static_window =
                (start_min < end_min and start_min <= now_min < end_min)
                or
                (start_min > end_min and (now_min >= start_min or now_min < end_min))
            %}

            {% set static_off_peak =
                STATIC_OFF_PEAK_ENABLED and static_window
            %}

            {% set static_excluded =
                static_window and not STATIC_OFF_PEAK_ENABLED
            %}

            {# ---- EV eligibility ---- #}
            {% set ev_slot_eligible =
                EV_CHARGING
                and minutes_into_slot >= BLEED_OVER_MINUTES
                and minutes_remaining >= WORTH_IT_MINUTES
            %}

            {# ---- Octopus confirmation ---- #}
            {% set octopus_on_this_slot =
                OCTOPUS_ON and minutes_into_slot >= OCTOPUS_GRACE_MINUTES
            %}

            {# ---- Slot confirmed ---- #}
            {% set slot_confirmed =
                ev_slot_eligible and octopus_on_this_slot
            %}

            {# ---- Previous HH static window (look-back) ---- #}
            {% set prev_ts = now_ts - timedelta(minutes=1) %}
            {% set prev_min = prev_ts.hour * 60 + prev_ts.minute %}

            {% set previous_hh_static =
                (start_min < end_min and start_min <= prev_min < end_min)
                or
                (start_min > end_min and (prev_min >= start_min or prev_min < end_min))
            %}

            {% set previous_hh_offpeak =
                prev_state
                or (
                  previous_hh_static
                  and OCTOPUS_ON
                )
            %}

            {# ---- Contiguous HH bridge (boundary-only) ---- #}
            {% set contiguous_bridge =
                CONTIGUOUS_HH_MODE
                and previous_hh_offpeak
                and minutes_into_slot < OCTOPUS_GRACE_MINUTES
                and OCTOPUS_ON
            %}

            {# ---- Final stateless latch ---- #}
            {% if static_excluded %}
              false
            {% else %}
              {{
                (STATIC_OFF_PEAK_ENABLED and static_window)
                or contiguous_bridge
                or slot_confirmed
                or (
                  prev_state
                  and state_attr(this.entity_id,'sensor_latched_at') is not none
                  and (
                    as_timestamp(
                      strptime(
                        state_attr(this.entity_id,'sensor_latched_at'),
                        '%Y-%m-%d %H:%M:%S'
                      )
                    )
                    >=
                    as_timestamp(
                      now().replace(minute=slot_start_minute, second=0)
                    )
                  )
                )
              }}
            {% endif %}
          attributes:
            hh_start: >
              {% set h = now().hour %}
              {% set m = 0 if now().minute < 30 else 30 %}
              {{ "%02d:%02d" | format(h, m) }}

            hh_end: >
              {% set h = now().hour %}
              {% if now().minute < 30 %}
                {{ "%02d:30" | format(h) }}
              {% else %}
                {{ "%02d:00" | format((h + 1) % 24) }}
              {% endif %}

            octopus_last_on_hh: >
              {% set OCTOPUS_ON = is_state('binary_sensor.octopus_intelligent_dispatching','on') %} {# <-- YOUR OCTOPUS OFFPEAK SENSOR GOES HERE. Check attributes below too #}
              {% if OCTOPUS_ON %}
                {% set h = now().hour %}
                {% set m = 0 if now().minute < 30 else 30 %}
                {{ "%02d:%02d" | format(h, m) }}
              {% else %}
                {{ state_attr(this.entity_id,'octopus_last_on_hh') }}
              {% endif %}

            slot_ev_eligible: >
              {% set OFF_PEAK_START = "23:00" %}
              {% set OFF_PEAK_END   = "05:30" %}
              {% set STATIC_OFF_PEAK_ENABLED = is_state('input_boolean.companion_charging_during_off_peak','on')  %}
              {% set BLEED_OVER_MINUTES = 4 %}
              {% set WORTH_IT_MINUTES = 15 %}

              {% set now_ts = now() %}
              {% set now_min = now_ts.hour * 60 + now_ts.minute %}
              {% set slot_start = 0 if now_ts.minute < 30 else 30 %}
              {% set minutes_into_slot = now_ts.minute - slot_start %}
              {% set minutes_remaining = 30 - minutes_into_slot %}

              {% set start_min = OFF_PEAK_START[0:2]|int * 60 + OFF_PEAK_START[3:5]|int %}
              {% set end_min   = OFF_PEAK_END[0:2]|int * 60 + OFF_PEAK_END[3:5]|int %}
              {% set static_window =
                  (start_min < end_min and start_min <= now_min < end_min)
                  or
                  (start_min > end_min and (now_min >= start_min or now_min < end_min)) %}

              {% if static_window and not STATIC_OFF_PEAK_ENABLED %}
                false
              {% else %}
                {% set EV_CHARGING = states('sensor.zappi_plug_status') == 'Charging' %}
                {{ EV_CHARGING
                  and minutes_into_slot >= BLEED_OVER_MINUTES
                  and minutes_remaining >= WORTH_IT_MINUTES }}
              {% endif %}

            slot_blocked_by_octopus: >
              {% set OFF_PEAK_START = "23:00" %}
              {% set OFF_PEAK_END   = "05:30" %}
              {% set STATIC_OFF_PEAK_ENABLED = false %}
              {% set BLEED_OVER_MINUTES = 4 %}
              {% set WORTH_IT_MINUTES = 15 %}
              {% set OCTOPUS_GRACE_MINUTES = 2 %}

              {% set now_ts = now() %}
              {% set now_min = now_ts.hour * 60 + now_ts.minute %}
              {% set slot_start = 0 if now_ts.minute < 30 else 30 %}
              {% set minutes_into_slot = now_ts.minute - slot_start %}
              {% set minutes_remaining = 30 - minutes_into_slot %}

              {% set start_min = OFF_PEAK_START[0:2]|int * 60 + OFF_PEAK_START[3:5]|int %}
              {% set end_min   = OFF_PEAK_END[0:2]|int * 60 + OFF_PEAK_END[3:5]|int %}
              {% set static_window =
                  (start_min < end_min and start_min <= now_min < end_min)
                  or
                  (start_min > end_min and (now_min >= start_min or now_min < end_min)) %}

              {% if static_window and not STATIC_OFF_PEAK_ENABLED %}
                false
              {% else %}
                {% set EV_CHARGING = states('sensor.zappi_plug_status') == 'Charging' %}
                {% set ev_ok =
                    EV_CHARGING
                    and minutes_into_slot >= BLEED_OVER_MINUTES
                    and minutes_remaining >= WORTH_IT_MINUTES %}
                {% set OCTOPUS_ON = is_state('binary_sensor.octopus_intelligent_dispatching','on') %} {# <-- YOUR OCTOPUS OFFPEAK SENSOR GOES HERE. Check attributes below too #}
                {% set octopus_ok = OCTOPUS_ON and minutes_into_slot >= OCTOPUS_GRACE_MINUTES %}
                {{ ev_ok and not octopus_ok }}
              {% endif %}

            sensor_latched_at: >
              {% if is_state(this.entity_id,'on') %}
                {{ now().strftime("%Y-%m-%d %H:%M:%S") }}
              {% else %}
                {{ state_attr(this.entity_id,'sensor_latched_at') }}
              {% endif %}

            latched_hh: >
              {% if is_state(this.entity_id,'on') %}
                {% set h = now().hour %}
                {% set m = 0 if now().minute < 30 else 30 %}
                {{ "%02d:%02d" | format(h, m) }}
              {% else %}
                {{ state_attr(this.entity_id,'latched_hh') }}
              {% endif %}

    - sensor:
        - name: "Companion SoC Distance"
          unique_id: companion_soc_distance
          unit_of_measurement: "%"
          icon: mdi:battery-arrow-down
          # Sensor is only available if all critical inputs exist
          availability: >
            {% set soc = states('sensor.solax_local_battery_soc') %}
            {% set reserve_soc = states('sensor.battery_budget_reserve_soc') %}
            {{ not (
              soc in ['unknown','unavailable','none'] or
              reserve_soc in ['unknown','unavailable','none']
            ) }}
          # Numeric state calculation, only runs when available
          state: >
            {% set soc = states('sensor.solax_local_battery_soc') | float %}
            {% set reserve_soc = states('sensor.battery_budget_reserve_soc') | int %}
            {{ ([(soc - reserve_soc), 0] | max) | round(2) }}
            