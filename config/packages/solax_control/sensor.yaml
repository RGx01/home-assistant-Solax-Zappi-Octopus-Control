    ###################################
    # Solax X1 Hybrid G4 Rest Sensors #
    ###################################
    # v1.3.0 Added:
    #  headers:
    #    Connection: "close"
    #    Cache-Control: "no-cache"
    # This means:
    # HA will not reuse the same socket between multiple requests,
    # it protects from intermediaries (like switches, NAT, or the inverterâ€™s own HTTP daemon) can cache or drop traffic silently,
    # and stale responses can appear valid ).
    # If you send Connection: close in your headers, each REST command:
    # Opens a new TCP connection,
    # Sends your POST/GET,
    # Forces the inverter to respond fresh,
    # Then closes the connection cleanly.
    # Enables templates to confirm a response was valid.
    #
    # V1.0.0
    # 12 - Feed In Min SOC %
    # 13 - Feed In Charge from grid to %
    # 14 - battery heating enable - read only unless the dongle is unlocked
    # 15 - heat start - read only unless the dongle is unlocked
    # 16 - heat end - read only unless the dongle is unlocked
    # 17 - heat start 2 - read only unless the dongle is unlocked
    # 18 - heat end 2 - read only unless the dongle is unlocked
    # 19 - System state
    # 20 - battery heat level - read only unless the dongle is unlocked
    ###################################
solax_control_sensor:
  sensor:
    - platform: rest
      scan_interval: 3599
      unique_id: solax_rest_local_settings
      resource: !secret solax_local_ip
      payload: !secret solax_local_settings_payload
      method: POST
      headers:
        Connection: "close"
        Cache-Control: "no-cache"
      name: "solax_rest_local_settings"
      force_update: true
      timeout: 9 # this must be carefully balanced or be less than refresh_delay in the solax_set_mode_and_settings script.
      # Unfortunately settings are not returned as a JSON document but an array of numbers, so having to pick just the relevant to avoid the max 255 chars limit
      # 0 - Self Use Min SOC %
      # 1 - Self Use Charge from grid (0 for disabled, 1 for enabled)
      # 2 - Self Use Charge from grid to %
      # 3 - Forced charge start
      # 4 - Forced charge end
      # 5 - Allowed discharge start
      # 6 - Allowed discharge end
      # 7 - Charge/discharge Period2 Enabled (0 for disabled, 1 for enabled)
      # 8 - Forced charge start (2nd)
      # 9 - Forced charge end (2nd)
      # 10 - Inverter mode - 0: self use, 1: feed in priority, 2: back up, 3: manual
      # 11 - Manual mode behaviour - 0: do nothing, 1: forced charge, 2: forced discharge
      # 12 - Feed In Min SOC %
      # 13 - Feed In Charge from grid to %
      # 14 - battery heating enable
      # 15 - heat start
      # 16 - heat end
      # 17 - heat start 2
      # 18 - heat end 2
      # 19 - System State On/Off
      # 20 - Battery Heating Level
      value_template: "{{ '[' ~
        value.split(',')[28] ~ ',' ~
        value.split(',')[29] ~ ',' ~
        value.split(',')[30] ~ ',' ~
        value.split(',')[36] ~ ',' ~
        value.split(',')[37] ~ ',' ~
        value.split(',')[38] ~ ',' ~
        value.split(',')[39] ~ ',' ~
        value.split(',')[40] ~ ',' ~
        value.split(',')[41] ~ ',' ~
        value.split(',')[42] ~ ',' ~
        value.split(',')[27] ~ ',' ~
        value.split(',')[35] ~ ',' ~
        value.split(',')[31] ~ ',' ~
        value.split(',')[32] ~ ',' ~
        value.split(',')[115] ~ ',' ~
        value.split(',')[116] ~ ',' ~
        value.split(',')[117] ~ ',' ~
        value.split(',')[118] ~ ',' ~
        value.split(',')[119] ~ ',' ~
        value.split(',')[46] ~ ',' ~       
        value.split(',')[264] ~ ']' }}"


