- id: '5000'
  alias: 5000 - Solax Zappi Octopus Control - House Keeping
  description: "# 5000 - Solax Zappi Octopus Control - House Keeping\n---\n- v9.0.0
    Changes to IOG 6hr limit\n---\n- v8.0.0 Minor updates to triggers\n---\n- v7.0.0
    New function Battery Budget\n---\n- v1.0.0 Initial \nSee documentation in repo"
  triggers:
  - trigger: state
    entity_id:
    - input_boolean.octopus_schedule_anytime
    to: 'on'
    id: Octopus Schedule Any Time
    alias: Octopus Schedule Any Time
  - trigger: state
    entity_id:
    - input_boolean.use_fixed_time
    to: 'on'
    id: Octopus Schedule Fixed Time
  - trigger: state
    entity_id:
    - input_boolean.solar_export_priority
    to: 'on'
    id: Octopus Schedule After Sunset
  - trigger: state
    entity_id:
    - input_boolean.zappi_eco_always
    for:
      hours: 0
      minutes: 0
      seconds: 30
    id: Zappi eco mode
    alias: Zappi ECO Mode
  - entity_id:
    - sensor.solax_local_battery_soc
    below: input_number.solax_default_discharge_limit_soc
    for:
      hours: 0
      minutes: 1
      seconds: 1
    id: Battery at min SoC
    trigger: numeric_state
    value_template: '{{ state.state | float(0)  - 1 }}'
    alias: Battery Flat
  - trigger: template
    value_template: '{{state_attr(''sensor.solax_local_settings'',''using_cache'')}}'
    id: using cached values warning
    alias: Alert to using cached values
  - trigger: state
    entity_id:
    - binary_sensor.upcoming_free_electricity
    to: 'on'
    for:
      hours: 0
      minutes: 2
      seconds: 0
    id: Octopus New Free Electric
  - trigger: state
    entity_id:
    - binary_sensor.free_electricity_today
    id: Free Electric Start
    to: 'on'
    from: 'off'
  - trigger: state
    entity_id:
    - binary_sensor.free_electricity_today
    id: Free Electric Stop
    to: 'off'
    from: 'on'
  - entity_id:
    - input_button.solax_force_discharge
    id: Discharge Manual Button - Start
    trigger: state
    alias: Discharge Manual Button - Start
  - entity_id:
    - input_button.solax_stop_discharge
    id: Discharge Manual Button - Stop
    trigger: state
    alias: Discharge Manual Button - Stop
  - trigger: state
    entity_id:
    - binary_sensor.manual_discharge_allowed
    to: 'on'
    id: Discharge Manual Start
    from: 'off'
    alias: Discharge Manual - Start
  - trigger: state
    entity_id:
    - binary_sensor.manual_discharge_allowed
    to: 'off'
    id: Discharge Manual End
    from: 'on'
    alias: Discharge Manual - End
  - trigger: state
    entity_id:
    - binary_sensor.daily_export_discharge_allowed
    to: 'on'
    id: Discharge Daily Start
    from: 'off'
    alias: Discharge Daily - Start
  - alias: Discharge Daily - End
    trigger: state
    entity_id:
    - binary_sensor.daily_export_discharge_allowed
    to: 'off'
    id: Discharge Daily End
    from: 'on'
  - trigger: state
    entity_id:
    - binary_sensor.jit_2330_discharge_allowed
    to: 'on'
    id: Discharge Nightly Start
    from: 'off'
    alias: Discharge Nightly - Start
  - alias: Discharge Nightly - End
    trigger: state
    entity_id:
    - binary_sensor.jit_2330_discharge_allowed
    to: 'off'
    id: Discharge Nightly End
    from: 'on'
  - trigger: state
    entity_id:
    - binary_sensor.ev_gap_discharge_allowed
    to: 'on'
    id: Discharge Gap Start
    from: 'off'
    alias: Discharge Gap - Start
  - trigger: state
    entity_id:
    - binary_sensor.ev_gap_discharge_allowed
    to: 'off'
    id: Discharge Gap End
    from: 'on'
    alias: Discharge Gap - End
  - trigger: state
    entity_id:
    - sensor.octopus_tariff_state
    to:
    - offpeak
    - peak
    - free
    id: Set Tariff
    alias: Set Tariff
  - trigger: state
    entity_id:
    - input_boolean.export_battery_manual
    - binary_sensor.manual_discharge_allowed
    for:
      hours: 0
      minutes: 0
      seconds: 10
    id: Reset the manual discharge flag
    alias: Reset Manual Discharge Flag
  - trigger: homeassistant
    event: start
    id: HA Start
    alias: HA Start
  - trigger: homeassistant
    event: start
    id: HA Start pyscript
    alias: HA Start Pyscript
  - trigger: state
    entity_id:
    - sensor.solax_zappi_octopus_device_list
    attribute: mobile_devices
    id: Get Mobile Device List
    alias: Get Mobile Device List
  - trigger: state
    entity_id:
    - sensor.solax_rest_local_settings
    to:
    - unknown
    - unavailable
    - None
    id: Alert when Solax settings are empty
    alias: Sensor Failed
  - alias: House Power Stat
    trigger: state
    entity_id:
    - input_number.power_stat_avg_days
    - input_select.slot_end
    - input_select.slot_interval
    - input_select.slot_start
    - input_datetime.solax_battery_start_charge_time
    - input_datetime.solax_battery_stop_charge_time
    id: house_power_average_power_stat
    for:
      hours: 0
      minutes: 0
      seconds: 10
  - alias: House Power Stat
    trigger: template
    id: house_power_average_power_stat
    value_template: "{% set ts = state_attr('sensor.solax_grid_stored_at_first_max_soc','timestamp')
      %} {% if ts in [None, '', 'unknown', 'unavailable'] %}\n  false\n{% else %}\n
      \ {% set dt = as_datetime(ts) %}\n  {% if dt is none %}\n    false\n  {% else
      %}\n    {{ now() >= dt + timedelta(minutes=1) }}\n  {% endif %}\n{% endif %}\n"
  - alias: New Octopus Dispatch
    trigger: state
    entity_id:
    - sensor.octopus_total_planned_dispatch
    - number.octopus_intelligent_charge_target
    id: Dispatch for this session
    for:
      hours: 0
      minutes: 0
      seconds: 10
  - trigger: state
    entity_id:
    - switch.octopus_intelligent_smart_charge
    id: Dispatch for this session
    to:
    - 'off'
    alias: New Octopus Dispatch
  - trigger: state
    entity_id:
    - sensor.octopus_total_planned_dispatch
    from:
    - '0'
    id: New Octopus Dispatch Notification
    alias: New Octopus Dispatch Notification
  - trigger: state
    entity_id:
    - binary_sensor.battery_discharge_now
    to:
    - 'on'
    - 'off'
    id: discharge can occur helper
    alias: Discharge Helper
  - trigger: time
    at: '12:00:00'
    id: Reset Zappi Usage @ Noon
    alias: Reset Octopus Usage Limits
  - trigger: state
    entity_id:
    - select.ev_charging_daily_vehicle
    for:
      hours: 0
      minutes: 0
      seconds: 5
    alias: Mirror EV Utility Meter
    id: Mirror EV Utility Meter
  - trigger: state
    entity_id:
    - binary_sensor.ev_currently_plugged_in
    to:
    - 'on'
    for:
      hours: 0
      minutes: 0
      seconds: 10
    from:
    - 'off'
    id: Which EV Connected
    alias: Which EV Connected
  - alias: Which EV Connected
    trigger: state
    entity_id:
    - input_boolean.ignore_6hr
    - input_number.limit_ev_kwh_charge_target
    for:
      hours: 0
      minutes: 0
      seconds: 10
    id: Which EV Connected
  - trigger: state
    entity_id:
    - switch.octopus_intelligent_smart_charge
    from:
    - 'on'
    to:
    - 'off'
    for:
      hours: 0
      minutes: 5
      seconds: 0
    id: Octopus Smart Charge Off
    alias: Octopus Smart Charge Off
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - Octopus Schedule Any Time
      sequence:
      - action: input_boolean.turn_off
        metadata: {}
        data: {}
        target:
          entity_id:
          - input_boolean.solar_export_priority
          - input_boolean.use_fixed_time
    - conditions:
      - condition: trigger
        id:
        - Octopus Schedule Fixed Time
      sequence:
      - action: input_boolean.turn_off
        metadata: {}
        data: {}
        target:
          entity_id:
          - input_boolean.solar_export_priority
          - input_boolean.octopus_schedule_anytime
    - conditions:
      - condition: trigger
        id:
        - Octopus Schedule After Sunset
      sequence:
      - action: input_boolean.turn_off
        metadata: {}
        data: {}
        target:
          entity_id:
          - input_boolean.octopus_schedule_anytime
          - input_boolean.use_fixed_time
    - conditions:
      - condition: trigger
        id:
        - Zappi Fault
      sequence:
      - event: Solax Zappi Octopus Control
        event_data:
          message: ZAPPI FAULT @ {{now().strftime('%H:%M')}}. Go outside and follow
            instructions on charger
          title: ZAPPI FAULT
          class: high
        enabled: true
    - conditions:
      - condition: trigger
        id:
        - Battery at min SoC
      - condition: state
        entity_id: binary_sensor.octopus_intelligent_dispatching
        state: 'off'
      sequence:
      - event: Solax Zappi Octopus Control
        event_data:
          message: Battery close to min SoC {{now().strftime('%H:%M')}}. {{states('sensor.solax_local_battery_soc')}}%
          title: Battery Flat
          class: high
        enabled: true
      alias: Battery Flat
    - conditions:
      - condition: trigger
        id:
        - using cached values warning
      sequence:
      - event: Solax Zappi Octopus Control
        event_data:
          message: Using Cached Settings @ {{now().strftime('%H:%M')}}. Settings and
            Modes cant be trusted. This could be trensient issue or signal that there
            is a comms issue.
          title: CACHED SETTINGS
          class: high
    - conditions:
      - condition: trigger
        id:
        - Octopus New Free Electric
      sequence:
      - if:
        - condition: template
          value_template: '{% set event_start = state_attr(''binary_sensor.upcoming_free_electricity'',''next_session_start'')
            %}

            {{event_start|as_timestamp>now()|as_timestamp}}'
        then:
        - event: Solax Zappi Octopus Control
          event_data:
            message: '{% set event_start = state_attr(''binary_sensor.upcoming_free_electricity'',''next_session_start'')|as_datetime
              %}It starts at {{event_start.strftime(''%H:%M'') }} on {{ event_start.day
              }}/{{event_start.month }} for {{ state_attr(''binary_sensor.upcoming_free_electricity'',''next_session_duration'')  }}
              minutes.

              '
            title: Octopus Free Electric Session
            class: high
    - conditions:
      - condition: trigger
        id:
        - Free Electric Start
      - condition: state
        entity_id: input_boolean.free_electric
        state: 'on'
      sequence:
      - event: Solax Zappi Octopus Control
        event_data:
          message: 'Free electric session started @ {{now().strftime(''%H:%M'')}}. '
          title: Free Electric Start
          class: high
        enabled: true
    - conditions:
      - condition: trigger
        id:
        - Free Electric Stop
      - condition: state
        entity_id: input_boolean.free_electric
        state: 'on'
      sequence:
      - event: Solax Zappi Octopus Control
        event_data:
          message: 'Free electric session finished @ {{now().strftime(''%H:%M'')}}. '
          title: Free Electric Finished
          class: high
        enabled: true
    - conditions:
      - condition: trigger
        id:
        - Discharge Manual Button - Start
      - condition: template
        value_template: '{{(state_attr(''sensor.solax_local_settings'', ''Data'')[10]
          != 3)}}'
      sequence:
      - if:
        - condition: numeric_state
          entity_id: sensor.solax_local_battery_soc
          above: input_number.solax_manual_forced_discharge_limit_soc
          value_template: '{{ state.state | float(0)  - 5 }}'
        then:
        - action: input_boolean.turn_on
          metadata: {}
          data: {}
          target:
            entity_id: input_boolean.export_battery_manual
      alias: Discharge Manual Button - Start
    - conditions:
      - condition: trigger
        id:
        - Discharge Manual Button - Stop
      - condition: template
        value_template: "{{(state_attr('sensor.solax_local_settings', 'Data')[10]
          != default_mode) \nor (state_attr('sensor.solax_local_settings', 'Data')[0]
          != min_soc) \nor (state_attr('sensor.solax_local_settings', 'Data')[12]
          != min_soc)}}"
      sequence:
      - action: input_boolean.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: input_boolean.export_battery_manual
      alias: Discharge Manual Button - Stop
    - conditions:
      - condition: trigger
        id:
        - Discharge Manual Start
      sequence:
      - event: Solax Zappi Octopus Control
        event_data:
          message: 'Attempting Discharge @ {{now().strftime(''%H:%M'')}}. '
          title: Manual Battery Export Started
          class: normal
        enabled: true
      alias: Discharge Manual - Start
    - conditions:
      - condition: trigger
        id:
        - Discharge Manual End
      sequence:
      - event: Solax Zappi Octopus Control
        event_data:
          message: 'Discharge finished @ {{now().strftime(''%H:%M'')}}. '
          title: Manual Battery Export Finished
          class: normal
        enabled: true
      alias: Discharge Manual- End
    - conditions:
      - condition: trigger
        id:
        - Discharge Daily Start
      sequence:
      - event: Solax Zappi Octopus Control
        event_data:
          message: 'Attempting Discharge @ {{now().strftime(''%H:%M'')}}. '
          title: Daily Battery Export Started
          class: normal
        enabled: true
      alias: Discharge Daily - Start
    - conditions:
      - condition: trigger
        id:
        - Discharge Daily End
      sequence:
      - event: Solax Zappi Octopus Control
        event_data:
          message: 'Discharge finished @ {{now().strftime(''%H:%M'')}}. '
          title: Daily Battery Export Finished
          class: normal
        enabled: true
      alias: Discharge Daily - End
    - conditions:
      - condition: trigger
        id:
        - Discharge Nightly Start
      sequence:
      - event: Solax Zappi Octopus Control
        event_data:
          message: 'Attempting Discharge @ {{now().strftime(''%H:%M'')}}. '
          title: Nightly Battery Export Started
          class: normal
        enabled: true
      alias: Discharge Nightly - Start
    - conditions:
      - condition: trigger
        id:
        - Discharge Nightly End
      sequence:
      - event: Solax Zappi Octopus Control
        event_data:
          message: 'Finished Discharge @ {{now().strftime(''%H:%M'')}}. '
          title: Nightly Battery Export Finished
          class: normal
        enabled: true
      alias: Discharge Nightly - End
    - conditions:
      - condition: trigger
        id:
        - Discharge Gap Start
      sequence:
      - event: Solax Zappi Octopus Control
        event_data:
          message: 'Attempting Discharge @ {{now().strftime(''%H:%M'')}}. '
          title: Battery Export in Dispatch Gap - Started
          class: normal
        enabled: true
      alias: Discharge Gap - Start
    - conditions:
      - condition: trigger
        id:
        - Discharge Gap End
      sequence:
      - event: Solax Zappi Octopus Control
        event_data:
          message: 'Finished Discharge @ {{now().strftime(''%H:%M'')}}. '
          title: Battery Export in Dispatch Gap - Finished
          class: normal
        enabled: true
      alias: Discharge Gap - End
    - conditions:
      - condition: trigger
        id:
        - Set Tariff
      sequence:
      - action: select.select_option
        metadata: {}
        data:
          option: '{{ states(''sensor.octopus_tariff_state'') }}'
        target:
          entity_id:
          - select.daily_grid_import
          - select.monthly_grid_import
          - select.daily_grid_import_myenergi
          - select.monthly_grid_import_myenergi
      alias: Set Tariff
    - conditions:
      - condition: trigger
        id:
        - Reset the manual discharge flag
      sequence:
      - if:
        - condition: template
          value_template: "{{ is_state('input_boolean.export_battery_manual', 'on')\n
            \                 and not (\n                    is_state('binary_sensor.manual_discharge_allowed',
            'on')\n                  )\n                }}"
        then:
        - action: input_boolean.turn_off
          target:
            entity_id: input_boolean.export_battery_manual
          data: {}
      alias: Reset Manual Discharge Flag
    - conditions:
      - condition: trigger
        id:
        - HA Start
        - Get Mobile Device List
      sequence:
      - action: input_select.set_options
        metadata: {}
        data:
          options: '{% set opts = (state_attr(''sensor.solax_zappi_octopus_device_list'',''mobile_devices''))
            | map(attribute=''device'') | list %}     {{ opts if opts else [''Default'']
            }} '
        target:
          entity_id: input_select.solax_automation_notification_devices
      alias: Get Mobile Device List
    - conditions:
      - condition: trigger
        id:
        - Alert when Solax settings are empty
      sequence:
      - event: Solax Zappi Octopus Control
        event_data:
          message: solax_rest_local_settings became unavailable @ {{now().strftime('%H:%M')}}.  {{states('sensor.solax_rest_local_settings')}}
          title: Sensor Failed
          class: high
      alias: Sensor Failed
    - conditions:
      - condition: trigger
        id:
        - HA Start pyscript
      sequence:
      - action: pyscript.battery_budget_schedule
        metadata: {}
        data: {}
        enabled: true
      - delay:
          hours: 0
          minutes: 0
          seconds: 50
          milliseconds: 0
      - action: pyscript.battery_budget_allocator
        metadata: {}
        data: {}
        enabled: true
      alias: House Power Stat
    - conditions:
      - condition: trigger
        id:
        - house_power_average_power_stat
      sequence:
      - action: pyscript.battery_budget_schedule
        metadata: {}
        data: {}
        enabled: true
      - action: input_number.set_value
        metadata: {}
        data:
          value: '{{state_attr(''sensor.battery_budget_reserve'',''daily_average_kw'')
            | float(0.5) }}'
        target:
          entity_id: input_number.typical_house_power
      alias: House Power Stat
    - conditions:
      - condition: trigger
        id:
        - Dispatch for this session
      - condition: template
        value_template: '{{now()|as_timestamp-states(''sensor.uptime'')|as_timestamp>80}}'
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: "{{ \n  trigger.entity_id == 'sensor.octopus_total_planned_dispatch'\n
              \ and trigger.from_state is not none\n  and (trigger.from_state.state
              | float(0)) == 0\n  and (trigger.to_state.state | float(0)) != 0\n  and
              ((trigger.from_state.state | float) != (trigger.to_state.state | float))\n
              \ and (\n        (states('input_number.octopus_intelligent_total_dispatch')
              | float(0)) == 0 or (\n          states['number.octopus_intelligent_charge_target']
              is not none\n          and (\n            as_timestamp(states['number.octopus_intelligent_charge_target'].last_changed)\n
              \           >= (as_timestamp(trigger.to_state.last_changed) - 60)\n
              \         )\n        )\n      )\n}}\n"
          sequence:
          - action: input_number.set_value
            metadata: {}
            data:
              value: '{{ states(''sensor.octopus_total_planned_dispatch'') | float(0)
                }}

                '
            target:
              entity_id: input_number.octopus_intelligent_total_dispatch
        - conditions:
          - condition: template
            value_template: '{{ trigger.entity_id == ''number.octopus_intelligent_charge_target''
              and (states(''input_number.octopus_intelligent_total_dispatch'') | float(0))
              != 0 }}

              '
          sequence:
          - action: input_number.set_value
            metadata: {}
            data:
              value: '{{ states(''sensor.octopus_total_planned_dispatch'') | float(0)
                }}

                '
            target:
              entity_id: input_number.octopus_intelligent_total_dispatch
        - conditions:
          - condition: template
            value_template: '{{ trigger.entity_id == ''switch.octopus_intelligent_smart_charge''
              and trigger.to_state.state == ''off'' }}

              '
          sequence:
          - action: input_number.set_value
            metadata: {}
            data:
              value: '0

                '
            target:
              entity_id: input_number.octopus_intelligent_total_dispatch
      alias: New Octopus Dispatch
    - conditions:
      - condition: trigger
        id:
        - New Octopus Dispatch Notification
      - condition: not
        conditions:
        - condition: state
          entity_id: sensor.octopus_total_planned_dispatch
          state:
          - unavailable
          - unknown
      sequence:
      - event: Solax Zappi Octopus Control
        event_data:
          message: Octopus Planned Dispatch @ {{now().strftime('%H:%M')}}.  {{states('sensor.octopus_total_planned_dispatch')}}kWh.
          title: Octopus Dispatch
          class: normal
      alias: New Octopus Dispatch Notification
    - conditions:
      - condition: trigger
        id:
        - discharge can occur helper
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ trigger.to_state.state == ''on'' }}'
          sequence:
          - action: input_boolean.turn_on
            metadata: {}
            data: {}
            target:
              entity_id: input_boolean.battery_discharge_now
        - conditions:
          - condition: template
            value_template: '{{ trigger.to_state.state == ''off'' }}'
          sequence:
          - action: input_boolean.turn_off
            metadata: {}
            data: {}
            target:
              entity_id: input_boolean.battery_discharge_now
      alias: Discharge Helper
    - conditions:
      - condition: trigger
        id:
        - Reset Zappi Usage @ Noon
        - HA Start
      - condition: template
        value_template: "{# Load last reset time #}\n{% set last = states('input_datetime.charging_24hr_allowance')
          %}\n{% if last in ['unknown','unavailable','None','', '0'] %}\n  {% set
          last_dt = none %}\n{% else %}\n  {% set last_dt = as_datetime(last) %}\n{%
          endif %}\n\n{# Today's noon #}\n{% set today_noon = now().replace(hour=12,
          minute=0, second=0, microsecond=0) %}\n\n{#\n  Reset when:\n  - It is the
          12:00 trigger (hour/minute match)\n  - OR HA started after noon AND last
          reset missing/old\n#}\n\n{% if now().hour == 12 and now().minute == 0 %}\n
          \ true\n{% else %}\n  {{ now() > today_noon and (last_dt is none or last_dt
          < today_noon) }}\n{% endif %}\n"
      sequence:
      - action: utility_meter.calibrate
        metadata: {}
        target:
          entity_id:
          - sensor.charge_kwh_24hr_allowance
          - sensor.charge_time_24hr_allowance
        data:
          value: 0
      - action: input_datetime.set_datetime
        metadata: {}
        target:
          entity_id: input_datetime.charging_24hr_allowance
        data:
          datetime: '{{ now().replace(hour=12, minute=0, second=0, microsecond=0).isoformat()
            }}'
      - action: input_number.set_value
        metadata: {}
        data:
          value: 0
        target:
          entity_id: input_number.zappi_charging_minutes_6hr_limit
      - if:
        - condition: state
          entity_id: binary_sensor.ev_currently_plugged_in
          state:
          - 'on'
        then:
        - action: number.set_value
          metadata: {}
          target:
            entity_id: number.octopus_intelligent_charge_target
          data:
            value: "{# THIS TEMPLATE IS TO RESET THE 6HR LIMIT IF AN EARLY MORNING
              PLUGIN HAPPENS AFTER A PREVIOUS CHARGE #}\n\n{# --- Battery sizes ---
              #} \n{% set cap = state_attr('sensor.connected_ev_battery_size','registered_ev_size')|float
              %} \n{% set cap_ev = states('sensor.connected_ev_battery_size')|float
              %}  \n{# --- Max energy allowed per 24hrs 12:00 to 12:00 --- #}  {#
              --- Max energy allowed logic --- #} \n{% set ignore = is_state('input_boolean.ignore_6hr',
              'on') %} \n{% set max_kwh = cap if ignore else states('input_number.limit_ev_kwh_charge_target')|float
              %}\n{% set max_percent_ev = (max_kwh / cap_ev) * 100 %}  \n{# --- Which
              car is currently plugged in? --- #} \n{% set active_car = state_attr('binary_sensor.ev_currently_plugged_in','ev_name')
              %}  \n\n{# --- Current battery levels --- #}\n{% set battery_entity
              = state_attr('binary_sensor.ev_currently_plugged_in','battery_entity')%}\n{%
              set current_ev_level = state(battery_entity) %} \n\n{# --- Desired target
              % --- #} \n{% set target = 100 %}  \n \n\n{% set percent_needed = target
              - current_ev_level %}     \n{% set kwh_needed = (percent_needed / 100)
              * cap_ev %}     \n{% set percent_equiv = (kwh_needed / cap) * 100 %}
              \    \n{% set limited_percent = [percent_equiv, max_percent_ev] | min
              %}     \n{{ [limited_percent, 10] | max | int }}\n"
      alias: Reset Octopus Usage Limits
    - conditions:
      - condition: trigger
        id:
        - Mirror EV Utility Meter
      sequence:
      - action: select.select_option
        metadata: {}
        target:
          entity_id: select.ev_charging_monthly_vehicle
        data:
          option: '{{ states(''select.ev_charging_daily_vehicle'') }}'
      alias: Mirror EV Utility Meter
    - conditions:
      - condition: trigger
        id:
        - Which EV Connected
      - condition: template
        value_template: '{{state_attr(''binary_sensor.ev_currently_plugged_in'',''ev_name'')
          != ''unknown''}}

          '
      sequence:
      - action: select.select_option
        metadata: {}
        target:
          entity_id: select.ev_charging_daily_vehicle
        data:
          option: '{{state_attr(''binary_sensor.ev_currently_plugged_in'',''ev_name'')}}'
      - delay:
          hours: 0
          minutes: 0
          seconds: 0
          milliseconds: 200
      - action: number.set_value
        metadata: {}
        target:
          entity_id: number.octopus_intelligent_charge_target
        data:
          value: "{# --- Battery sizes --- #} \n{% set cap = state_attr('sensor.connected_ev_battery_size','registered_ev_size')|float
            %} \n{% set cap_ev = states('sensor.connected_ev_battery_size')|float
            %}  \n{# --- Max energy allowed per 24hrs 12:00 to 12:00 --- #}  {# ---
            Max energy allowed logic --- #} {% set ignore = is_state('input_boolean.ignore_6hr',
            'on') %} {% set max_kwh = cap if ignore else states('sensor.octopus_intelligent_remaining_today')|float
            %}\n{% set max_percent_ev = (max_kwh / cap_ev) * 100 %}  \n{# --- Which
            car is currently plugged in? --- #} \n{% set active_car = state_attr('binary_sensor.ev_currently_plugged_in','ev_name')
            %}  \n\n{# --- Current battery levels --- #} \n{% set current_ev_level
            = state_attr('binary_sensor.ev_currently_plugged_in','battery_level')
            | float %} \n\n{# --- Desired target % --- #} \n{% set target = 100 %}
            \ \n \n\n{% set percent_needed = target - current_ev_level %}     \n{%
            set kwh_needed = (percent_needed / 100) * cap_ev %}     \n{% set percent_equiv
            = (kwh_needed / cap) * 100 %}     \n{% set limited_percent = [percent_equiv,
            max_percent_ev] | min %}     \n{{ [limited_percent, 10] | max | int }}\n"
      alias: Which EV Connected
    - conditions:
      - condition: trigger
        id:
        - Octopus Smart Charge Off
      sequence:
      - action: number.set_value
        metadata: {}
        target:
          entity_id: number.octopus_intelligent_charge_target
        data:
          value: '10'
      alias: Octopus Smart Charge Off
    enabled: true
  mode: parallel
  trace:
    stored_traces: 20
  max: 20
- id: '5001'
  alias: 5001 - Solax Zappi Octopus Control
  description: "# 5001 - Solax Zappi Octopus Control\n---\n- v9.0.0  tweaks to triggers
    and bug fixes\n---\n- v8.2.0 tweaked the EV Ready logic in variables block, sometime
    EV charging bumps into the target time and so min_soc doesn't return to default\n---\n-
    v8.0.0 Attempt at trying to stop flip flopping around tiny Octopus dispatches
    and pauses\n---\n- v7.3.2 Logic changed around EV pause logic to stop flip flopping
    the min_soc when octopus does these small charges or small gaps between charges.
    Hopefully they sort it out.\n---\n- v7.0.0 New function Battery Budget\n---\n-
    v1.0.2 Minor bug fix to stop 'Finished Charge Message' when smart charge switch
    was off to begin with\n---\n-  v1.0.0 \n + Indent-potent handling of inverter
    mode and settings\n + Zappi and Octopus handling\n---\n\n"
  triggers:
  - entity_id:
    - sensor.zappi_plug_status
    from: Charging
    to: EV Disconnected
    id: Charging to Disconnected
    trigger: state
    alias: EV Disconnected
  - entity_id:
    - sensor.zappi_plug_status
    from: EV Connected
    to: EV Disconnected
    id: Connected to Disconnected
    trigger: state
    alias: EV Disconnected
  - alias: EV Disconnected
    entity_id:
    - sensor.zappi_plug_status
    from: Waiting for EV
    to: EV Disconnected
    id: Waiting to Disconnected
    trigger: state
  - alias: EV First Connected
    trigger: state
    entity_id:
    - sensor.zappi_plug_status
    from:
    - EV Disconnected
    to:
    - EV Connected
    id: EV Connected
    for:
      hours: 0
      minutes: 0
      seconds: 10
  - alias: EV Schedule Time
    at:
      entity_id: sensor.octopus_schedule_time
      offset: '10'
    id: Time to Start Charging
    trigger: time
  - entity_id:
    - sensor.zappi_plug_status
    from: Fault
    to: Charging
    id: Charging
    trigger: state
    alias: Charging
  - entity_id:
    - sensor.zappi_plug_status
    from: Waiting for EV
    to: Charging
    id: Charging
    trigger: state
    alias: Charging
  - entity_id:
    - sensor.zappi_plug_status
    to: Charging
    id: Charging
    from: EV Connected
    trigger: state
    alias: Charging
  - alias: EV Paused
    entity_id:
    - sensor.zappi_plug_status
    from:
    - Charging
    to:
    - EV Connected
    id: Paused EV Charging
    trigger: state
    for:
      hours: 0
      minutes: 9
      seconds: 0
  - alias: EV Paused
    entity_id:
    - sensor.zappi_plug_status
    from:
    - Waiting for EV
    to:
    - EV Connected
    id: Paused EV Charging
    trigger: state
    for:
      hours: 0
      minutes: 9
      seconds: 0
  - alias: Peak Rate
    entity_id:
    - binary_sensor.octopus_energy_electricity_off_peak
    to:
    - 'off'
    id: Peak Rate
    trigger: state
    from:
    - 'on'
    for:
      hours: 0
      minutes: 10
      seconds: 1
  - alias: Intelligent 6h limit
    trigger: template
    value_template: '{{(((states(''sensor.octopus_intelligent_time_allowance_remaining'')|float*3600)-120)<=0)and
      is_state(''input_boolean.ignore_6hr'',''off'')}}'
    id: 6h Limit
    enabled: true
  - alias: EV Ready
    trigger: time
    at:
      entity_id: sensor.octopus_intelligent_target_time
      offset: '-30'
    id: EV Ready
  - at: '23:30:00'
    id: '2330'
    enabled: true
    trigger: time
    alias: '2330'
  - alias: Discharge - Start
    trigger: state
    entity_id:
    - input_boolean.battery_discharge_now
    id: Discharge
    from: 'off'
    to: 'on'
    for:
      hours: 0
      minutes: 0
      seconds: 30
  - trigger: state
    entity_id:
    - input_boolean.battery_discharge_now
    id: Finished discharge
    from: 'on'
    to: 'off'
    for:
      hours: 0
      minutes: 0
      seconds: 5
    alias: Solax Discharge - End
  - alias: Solax Discharge - End Secondary
    trigger: state
    entity_id:
    - input_boolean.battery_discharge_now
    id: Finished discharge secondary trigger
    from: 'on'
    to: 'off'
    for:
      hours: 0
      minutes: 1
      seconds: 0
  - trigger: time
    at:
      entity_id: input_datetime.solax_battery_start_charge_time
      offset: '-300'
    id: Charge Solax
    alias: Set Charge Battery Mode
  - alias: Set Charge Battery Mode
    trigger: time
    at:
      entity_id: input_datetime.solax_battery_stop_charge_time
      offset: '-60'
    id: Charge Solax
  - trigger: state
    entity_id:
    - binary_sensor.solax_local_battery_charging_period
    id: Solax charging from grid start
    for:
      hours: 0
      minutes: 0
      seconds: 59
    from: 'off'
    to: 'on'
    alias: Regular Solax Charge - Start
  - trigger: state
    entity_id:
    - binary_sensor.solax_local_battery_charging_period
    id: Solax charging from grid stop
    for:
      hours: 0
      minutes: 0
      seconds: 59
    from: 'on'
    to: 'off'
    alias: Regular Solax Charge - Stop
  - trigger: state
    entity_id:
    - input_boolean.ev_solax_battery_drain
    - input_boolean.use_grid_during_octopus_dispatch
    id: Henley Block - Battery Usage Options
    alias: Henley Block
  - alias: Inverter Got Left in Manual Mode Catcher
    trigger: template
    value_template: "{{state_attr('sensor.solax_local_settings', 'Data')[10]|int(0)
      == 3 and\nstates('sensor.solax_local_battery_soc')|int <= \n(state_attr('sensor.solax_local_settings',
      'Data')[0]|int(10) ,state_attr('sensor.solax_local_settings', 'Data')[12]|int(10))|max
      }}\n\n"
    for:
      hours: 0
      minutes: 5
      seconds: 0
    id: Inverter shouldn't be left in this mode
  - alias: Inverter Got Left in Manual Mode Catcher
    trigger: template
    value_template: '{{state_attr(''sensor.solax_local_settings'', ''Data'')[11]|int(0)
      != 0 and state_attr(''sensor.solax_local_settings'', ''Data'')[10]|int(0) in
      [0,1]

      }}


      '
    for:
      hours: 0
      minutes: 5
      seconds: 0
    id: Inverter shouldn't be left in this mode
  - alias: Free Electric Prepare Solax Charge Period 2
    entity_id:
    - binary_sensor.free_electricity_today
    to: 'on'
    id: Free Electric Prepare
    trigger: state
    for:
      hours: 0
      minutes: 2
      seconds: 0
    enabled: true
    from: 'off'
  - at: sensor.octopus_free_electricity_stop
    id: Free Electric End - Stop EV Charging
    trigger: time
    enabled: true
    alias: Free Electric End - Stop EV Charging
  - alias: Charge Period 2 - End
    trigger: time
    at:
      entity_id: input_datetime.solax_stop_charge_2
      offset: '-60'
    id: Charge Period 2 End
  - alias: Check Settings
    trigger: template
    value_template: '{% set ev_charging = is_state(''sensor.zappi_plug_status'',''Charging'')%}

      {% set default_soc = states(''input_number.solax_default_discharge_limit_soc'')
      %}

      {% set min_soc = states(''sensor.solax_local_selfuse_battery_min_soc'')|int(default=15)
      if states(''sensor.solax_default_operation_mode'') | int(0) == 0 else states(''sensor.solax_local_feed_in_battery_min_soc'')|int(default=15)
      | int %}

      {% set soc = states(''sensor.solax_local_battery_soc'') | float(0) %}

      {% set batt_out = states(''sensor.solax_local_battery_use_out'')|float(0) <
      80 %}

      {% set valid_hours = now() > today_at("05:30") and now() < today_at("23:30")%}


      {{(not ev_charging) and soc <= min_soc and batt_out and valid_hours and default_soc
      != min_soc}}  '
    for:
      hours: 0
      minutes: 15
      seconds: 0
    id: Check Settings
  - trigger: state
    entity_id:
    - input_button.solax_submit_settings
    id: Submit Settings
    alias: Submit Settings
  conditions: []
  actions:
  - condition: template
    value_template: '{{now()|as_timestamp-states(''sensor.uptime'')|as_timestamp>80}}

      '
  - variables:
      default_mode: "{{ (1 if  (is_state('input_boolean.free_electric', 'on') and\n
        is_state('binary_sensor.free_electricity_today', 'on'))\nelse states('sensor.solax_default_operation_mode'))
        | int }}\n"
      min_soc: "{# ===============================================================\n
        \  min_soc decision rules\n\n   Special triggers:\n     - 2330:\n         →
        If prevent_ev_drain and (not charging OR use_grid): hold current SoC\n         →
        Else: default_soc\n\n   Charging period (binary_sensor.solax_local_battery_charging_period
        = on):\n     → Always default_soc\n\n   Charging→Disconnected transition (05:30–23:30):\n
        \    → Always default_soc\n\n   NEW: Daytime dispatch exception (05:30–23:30):\n
        \    - If dispatch_on = true AND ev_charging != charging:\n         → Force
        default_soc\n\n   Normal conditions:\n     EV charging:\n       - If prevent_ev_drain
        OR use_grid: hold current SoC\n       - Else: default_soc\n\n     EV not charging:\n
        \      - If dispatch_on AND prevent_ev_drain AND use_grid: hold current SoC\n
        \      - Else: default_soc\n\n   Summary:\n     → Two possible outputs: current_soc
        (discharge blocked) OR default_soc (discharge allowed)\n   ===============================================================
        #}\n\n  {% set ev_charging = is_state('sensor.zappi_plug_status','Charging')
        -%}  \n  {% set dispatch_on = is_state('binary_sensor.octopus_intelligent_dispatching','on')
        or is_state('binary_sensor.octopus_energy_electricity_off_peak','on') -%}\n
        \ {% set use_grid = is_state('input_boolean.use_grid_during_octopus_dispatch','on')
        -%}\n  {% set prevent_ev_drain = is_state('input_boolean.ev_solax_battery_drain','on')
        -%}\n  {% set default_soc = states('input_number.solax_default_discharge_limit_soc')|int
        -%}\n  {% set current_soc = states('sensor.solax_local_battery_soc')|int -%}\n
        \ {% set smart_charge = is_state('switch.octopus_intelligent_smart_charge','on')
        -%} \n  {% set discharging = is_state('binary_sensor.battery_discharge_now',
        'on') -%} \n  {% set target_time = states('sensor.octopus_intelligent_target_time')
        | as_datetime -%}\n  {% set today_0530 = now().replace(hour=5, minute=30,
        second=0, microsecond=0) -%}\n  \n  {# --- PRECOMPUTE STOP TIMES + FINAL WINDOW
        (works across midnight) --- #}\n\n  {% set stop1_raw = states('input_datetime.solax_battery_stop_charge_time')
        -%} \n  {% set stop1 = today_at(stop1_raw) %} {% if stop1 < now() -%}\n    {%
        set stop1 = stop1 + timedelta(days=1) -%}\n  {% endif -%}\n\n  {% if is_state('input_boolean.solaxchargeperiod2',
        'on') -%}\n      {% set stop2_raw = states('input_datetime.solax_stop_charge_2')
        -%}\n      {% set stop2 = today_at(stop2_raw) -%}\n      {% if stop2 < now()
        -%}\n        {% set stop2 = stop2 + timedelta(days=1) -%}\n      {% endif
        -%}\n  {% else -%}\n      {# If period2 is OFF, ignore stop2 by making it
        \"far in future\" #}\n      {% set stop2 = stop1 + timedelta(days=9999) -%}\n
        \ {% endif -%}\n\n  {# Determine which stop is next #} \n  {% if stop1 <=
        stop2 -%}\n      {% set stop_time = stop1 -%}\n  {% else %}\n      {% set
        stop_time = stop2 -%}\n  {% endif -%}\n\n  {# Are we in the final 2-minute
        window before the upcoming stop? #} \n  {% set final_window = now() >= (stop_time
        - timedelta(minutes=2)) and now() < stop_time -%}\n\n\n  {# --- Special triggers
        override everything. --- #}\n  {% if trigger.id in ['2330'] -%}\n    {% if
        discharging -%}\n      {{ default_soc }}\n    {% elif use_grid -%}\n      {{
        current_soc }}\n    {% elif prevent_ev_drain and ev_charging -%}\n      {{
        current_soc }}\n    {% else -%}\n      {{ default_soc }}\n    {% endif -%}\n\n\n
        \ {# --- Local battery charging period OR final 2 minutes before stop ---
        #}\n  {% elif is_state('binary_sensor.solax_local_battery_charging_period','on')
        or final_window -%}\n\n    {% if final_window and target_time.timestamp()
        > today_0530.timestamp() -%}\n        {# Use normal EV logic during final
        2 minutes when target_time > 05:30 #}\n        {# to avoid a second trigger
        when EV is still charging and it's time to turn off smart charge -->((target_time-
        timedelta(minutes=1))|as_timestamp<= now()|as_timestamp)#}\n        {% if
        ev_charging and ((target_time- timedelta(minutes=1))|as_timestamp >= now()|as_timestamp)
        -%}\n            {% if prevent_ev_drain or use_grid -%}\n                {{
        current_soc }}\n            {% else -%}\n                {{ default_soc }}\n
        \           {% endif -%}\n        {% elif ev_charging -%}\n            {%
        if prevent_ev_drain or use_grid -%}\n                {{ default_soc }}\n            {%
        else -%}\n                {{ default_soc }}\n            {% endif -%}\n        {%
        else -%}\n            {% if dispatch_on and prevent_ev_drain and use_grid
        -%}\n                {{ default_soc }}\n            {% else -%}\n                {{
        default_soc }}\n            {% endif -%}\n        {% endif -%}\n\n    {% else
        -%}\n        {# Earlier in charging period OR target_time <= 05:30 #}\n        {{
        default_soc }}\n    {% endif -%}\n\n\n    \n  {# --- Daytime Charging→Disconnected
        transition → allow discharge --- #}  \n  {% elif trigger.id in ['Charging
        to Disconnected','Connected to Disconnected'] and now() >= today_at(\"05:30\")
        and now() <= today_at(\"23:30\") -%}\n    {{ default_soc }}\n\n  {# --- NEW:
        Daytime dispatch, ev chargin OFF → force default discharge ---#}  \n  {% elif
        dispatch_on and not ev_charging and now() >= today_at(\"05:30\") and now()
        <= today_at(\"23:30\") -%}\n    {{ default_soc }}\n  {# --- Normal conditions
        --- #}  \n  {% else -%}\n    {% if ev_charging -%}\n      {% if prevent_ev_drain
        or use_grid %}\n        {% if ev_charging and ((target_time- timedelta(minutes=1))|as_timestamp
        - now()|as_timestamp) <120 -%}\n          {{ default_soc }}\n        {% else
        %}\n          {{ current_soc }}\n        {% endif %}\n      {% else %}\n        {{
        default_soc }}\n      {% endif %}\n    {% else -%}\n      {% if dispatch_on
        and prevent_ev_drain and use_grid -%}\n        {{ current_soc }}\n      {%
        else -%}\n        {{ default_soc }}\n      {% endif -%}\n    {% endif -%}\n
        \ {% endif -%}\n"
  - action: input_boolean.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: input_boolean.solax_automation_running
  - choose:
    - conditions:
      - condition: trigger
        id:
        - Connected to Disconnected
        - Charging to Disconnected
        - Waiting to Disconnected
      sequence:
      - if:
        - condition: template
          value_template: "{{(state_attr('sensor.solax_local_settings', 'Data')[10]
            != default_mode) \nor (state_attr('sensor.solax_local_settings', 'Data')[0]
            != min_soc) \nor (state_attr('sensor.solax_local_settings', 'Data')[12]
            != min_soc)}}"
        - condition: template
          value_template: '{{(state_attr(''sensor.solax_local_settings'', ''Data'')[10]
            != 3)}}'
          alias: Inverter not in manual mode
        then:
        - action: script.solax_set_mode_and_settings
          data:
            mode: '{{default_mode}}'
            settings:
              selfuse_battery_min_soc: '{{min_soc}}'
              feedin_battery_min_soc: '{{min_soc}}'
      - event: Solax Zappi Octopus Control
        event_data:
          message: EV disconnected @ {{now().strftime('%H:%M')}}
          title: EV Disconnected
          class: normal
        enabled: true
      - action: select.select_option
        metadata: {}
        data:
          option: Stopped
        target:
          entity_id: select.zappi_charge_mode
      - action: script.safe_switch_toggle
        data:
          target_switch: switch.octopus_intelligent_smart_charge
          desired_state: 'off'
          max_retries: 4
          backoff: 5
      alias: EV Disconnected
    - conditions:
      - condition: trigger
        id:
        - Time to Start Charging
        - Finished discharge secondary trigger
        - EV Connected
      - condition: state
        entity_id: sensor.zappi_plug_status
        state: EV Connected
      - condition: template
        value_template: '{{(state_attr(''sensor.solax_local_settings'', ''Data'')[10]
          != 3)}}'
        alias: Inverter not in manual mode
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: '{% set now_ts = now().timestamp() %}

              {% set start = (states(''sensor.octopus_schedule_time'') | as_timestamp)
              - 1 %}

              {% set end = states(''sensor.octopus_intelligent_target_time'') | as_timestamp
              %}


              {{ start < now_ts < end }}'
          sequence:
          - action: select.select_option
            metadata: {}
            data:
              option: Eco+
            target:
              entity_id: select.zappi_charge_mode
          - delay:
              hours: 0
              minutes: 0
              seconds: 10
              milliseconds: 0
          - action: script.safe_switch_toggle
            metadata: {}
            data:
              target_switch: switch.octopus_intelligent_smart_charge
              desired_state: 'on'
              max_retries: 4
              backoff: 5
          - choose:
            - conditions:
              - condition: template
                value_template: '{{(state_attr(''sensor.solax_local_settings'', ''Data'')[10]
                  != default_mode)}}'
              sequence:
              - action: script.solax_set_mode_and_settings
                data:
                  mode: '{{default_mode}}'
        - conditions:
          - condition: state
            entity_id: input_boolean.zappi_eco_always
            state: ''
          sequence:
          - action: select.select_option
            metadata: {}
            data:
              option: Eco+
            target:
              entity_id: select.zappi_charge_mode
        default:
        - action: select.select_option
          metadata: {}
          data:
            option: Stopped
          target:
            entity_id: select.zappi_charge_mode
      - if:
        - condition: numeric_state
          entity_id: sensor.octopus_total_planned_dispatch
          below: 1
        then:
        - event: Solax Zappi Octopus Control
          event_data:
            message: EV Connected @ {{(states('sensor.zappi_last_connected')|as_datetime|as_local).strftime("%H:%M")}}.Getting
              shedule at {%if now()|as_timestamp > states('sensor.octopus_schedule_time')|as_timestamp%}
              {{now().strftime('%H:%M')}} {% else %} {{(states('sensor.octopus_schedule_time')|as_datetime|as_local).strftime('%H:%M')}}.
              {% endif %}
            title: EV Connected - Waiting for Octopus schedule
            class: normal
      - action: input_number.set_value
        metadata: {}
        target:
          entity_id: input_number.zappi_charging_minutes
        data:
          value: 0
      - action: utility_meter.calibrate
        metadata: {}
        target:
          entity_id: sensor.zappi_time_spent_charging
        data:
          value: '0'
      alias: EV Connected
    - conditions:
      - condition: trigger
        id:
        - EV Ready
        - 6h Limit
      - condition: state
        entity_id: switch.octopus_intelligent_smart_charge
        state: 'on'
      sequence:
      - action: script.safe_switch_toggle
        metadata: {}
        data:
          target_switch: switch.octopus_intelligent_smart_charge
          desired_state: 'off'
          max_retries: 4
          backoff: 5
      - choose:
        - conditions:
          - condition: state
            entity_id: input_boolean.zappi_eco_always
            state:
            - 'on'
          sequence:
          - action: select.select_option
            metadata: {}
            data:
              option: Eco+
            target:
              entity_id: select.zappi_charge_mode
        default:
        - action: select.select_option
          metadata: {}
          data:
            option: Stopped
          target:
            entity_id: select.zappi_charge_mode
      - if:
        - condition: template
          value_template: "{{(state_attr('sensor.solax_local_settings', 'Data')[10]
            != default_mode) \nor (state_attr('sensor.solax_local_settings', 'Data')[0]
            != min_soc) \nor (state_attr('sensor.solax_local_settings', 'Data')[12]
            != min_soc)}}"
        then:
        - action: script.solax_set_mode_and_settings
          data:
            mode: '{{default_mode}}'
            settings:
              selfuse_battery_min_soc: '{{min_soc}}'
              feedin_battery_min_soc: '{{min_soc}}'
      - if:
        - condition: trigger
          id:
          - EV Ready
        then:
        - event: Solax Zappi Octopus Control
          event_data:
            message: Smart charge target reached @ {{now().strftime('%H:%M')}}
            title: EV Finished Charging
            class: normal
        else:
        - event: Solax Zappi Octopus Control
          event_data:
            message: Smart charge off @ {{now().strftime('%H:%M')}}
            title: EV Finished Charging 6hr Limit Reached
            class: normal
      alias: EV Ready
    - conditions:
      - condition: trigger
        id:
        - '2330'
      - condition: template
        value_template: "{{(state_attr('sensor.solax_local_settings', 'Data')[10]
          != default_mode) \nor (state_attr('sensor.solax_local_settings', 'Data')[0]
          != min_soc) \nor (state_attr('sensor.solax_local_settings', 'Data')[12]
          != min_soc)}}"
      - condition: template
        value_template: '{{(state_attr(''sensor.solax_local_settings'', ''Data'')[10]
          != 3)}}'
      sequence:
      - action: script.solax_set_mode_and_settings
        data:
          mode: '{{default_mode}}'
          settings:
            selfuse_battery_min_soc: '{{min_soc}}'
            feedin_battery_min_soc: '{{min_soc}}'
      alias: '2330'
    - conditions:
      - condition: trigger
        id:
        - Paused EV Charging
      - condition: template
        value_template: "{{(state_attr('sensor.solax_local_settings', 'Data')[10]
          != default_mode) \nor (state_attr('sensor.solax_local_settings', 'Data')[0]
          != min_soc) \nor (state_attr('sensor.solax_local_settings', 'Data')[12]
          != min_soc)}}"
      - condition: template
        value_template: '{{now()|as_timestamp < states(''sensor.octopus_intelligent_target_time'')|as_timestamp}}'
      sequence:
      - action: script.solax_set_mode_and_settings
        data:
          mode: '{{default_mode}}'
          settings:
            selfuse_battery_min_soc: '{{min_soc}}'
            feedin_battery_min_soc: '{{min_soc}}'
      - event: Solax Zappi Octopus Control
        event_data:
          message: EV paused charging @ {{now().strftime('%H:%M')}}. Zappi charge
            session {{states('sensor.zappi_charge_added_session')}}kWh.
          title: EV Charging Paused
          class: normal
        enabled: true
      alias: EV Paused
    - conditions:
      - condition: trigger
        id:
        - Charging
      - condition: state
        entity_id: sensor.zappi_plug_status
        state: Charging
      - condition: template
        value_template: "{{(state_attr('sensor.solax_local_settings', 'Data')[10]
          != default_mode) \nor (state_attr('sensor.solax_local_settings', 'Data')[0]
          != min_soc) \nor (state_attr('sensor.solax_local_settings', 'Data')[12]
          != min_soc)}}"
      sequence:
      - action: script.solax_set_mode_and_settings
        data:
          mode: '{{default_mode}}'
          settings:
            selfuse_battery_min_soc: '{{min_soc}}'
            feedin_battery_min_soc: '{{min_soc}}'
      - event: Solax Zappi Octopus Control
        event_data:
          message: EV started charging @ {{now().strftime('%H:%M')}}.
          title: EV Charging Started
          class: normal
        enabled: true
      alias: EV Charging
    - conditions:
      - condition: trigger
        id:
        - Peak Rate
      - condition: template
        value_template: "{{(state_attr('sensor.solax_local_settings', 'Data')[10]
          != default_mode) \nor (state_attr('sensor.solax_local_settings', 'Data')[0]
          != min_soc) \nor (state_attr('sensor.solax_local_settings', 'Data')[12]
          != min_soc)}}\n"
      - condition: template
        value_template: '{{(state_attr(''sensor.solax_local_settings'', ''Data'')[10]
          != 3)

          }}

          '
        enabled: true
      sequence:
      - action: script.solax_set_mode_and_settings
        data:
          mode: '{{default_mode}}'
          settings:
            selfuse_battery_min_soc: '{{min_soc}}'
            feedin_battery_min_soc: '{{min_soc}}'
      - event: Solax Zappi Octopus Control
        event_data:
          message: Peak Rate @ {{now().strftime('%H:%M')}}
          title: Peak Rate
          class: normal
      alias: Peak Rate
    - conditions:
      - condition: trigger
        id:
        - Charge Solax
      - condition: template
        value_template: "{{(state_attr('sensor.solax_local_settings', 'Data')[10]
          != default_mode) \nor (state_attr('sensor.solax_local_settings', 'Data')[0]
          != min_soc) \nor (state_attr('sensor.solax_local_settings', 'Data')[12]
          != min_soc)\n}}"
      sequence:
      - action: script.solax_set_mode_and_settings
        data:
          mode: '{{default_mode}}'
          settings:
            selfuse_battery_min_soc: '{{min_soc}}'
            feedin_battery_min_soc: '{{min_soc}}'
      alias: Set Charge Battery Mode
    - conditions:
      - condition: trigger
        id:
        - Solax charging from grid start
      - condition: template
        value_template: "{{(state_attr('sensor.solax_local_settings', 'Data')[10]
          != default_mode) \nor (state_attr('sensor.solax_local_settings', 'Data')[0]
          != min_soc) \nor (state_attr('sensor.solax_local_settings', 'Data')[12]
          != min_soc)\nor (state_attr('sensor.solax_local_settings', 'Data')[2] !=
          states('input_number.octopus_free_session_battery_prep_soc') if\n    is_state('binary_sensor.free_electricity_today','on')
          and\n    is_state('input_boolean.octopus_free_electric_soc_use','on') else\n
          \   states('input_number.solax_default_charge_to_limit_soc'))\nor (state_attr('sensor.solax_local_settings',
          'Data')[13] != states('input_number.octopus_free_session_battery_prep_soc')
          if\n    is_state('binary_sensor.free_electricity_today','on') and\n    is_state('input_boolean.octopus_free_electric_soc_use','on')
          else\n    states('input_number.solax_default_charge_to_limit_soc'))\n\n}}\n"
      sequence:
      - action: script.solax_set_mode_and_settings
        data:
          mode: '{{default_mode}}'
          settings:
            selfuse_battery_min_soc: '{{min_soc}}'
            feedin_battery_min_soc: '{{min_soc}}'
            selfuse_charge_battery_from_grid: '{{states(''input_number.octopus_free_session_battery_prep_soc'')
              if is_state(''binary_sensor.free_electricity_today'',''on'') and is_state(''input_boolean.octopus_free_electric_soc_use'',''on'')
              else states(''input_number.solax_default_charge_to_limit_soc'') }}'
            feedin_charge_battery_from_grid: '{{states(''input_number.octopus_free_session_battery_prep_soc'')
              if is_state(''binary_sensor.free_electricity_today'',''on'') and is_state(''input_boolean.octopus_free_electric_soc_use'',''on'')
              else states(''input_number.solax_default_charge_to_limit_soc'') }}'
      alias: Set Charge Battery Settings - Start
    - conditions:
      - condition: trigger
        id:
        - Solax charging from grid stop
      - condition: template
        value_template: "{{(state_attr('sensor.solax_local_settings', 'Data')[10]
          != default_mode) \nor (state_attr('sensor.solax_local_settings', 'Data')[0]
          != min_soc) \nor (state_attr('sensor.solax_local_settings', 'Data')[12]
          != min_soc)\nor (state_attr('sensor.solax_local_settings', 'Data')[2] !=
          states('input_number.solax_default_charge_to_limit_soc'))\nor (state_attr('sensor.solax_local_settings',
          'Data')[13] != states('input_number.solax_default_charge_to_limit_soc'))\n\n}}\n"
      sequence:
      - action: script.solax_set_mode_and_settings
        data:
          mode: '{{default_mode}}'
          settings:
            selfuse_battery_min_soc: '{{min_soc}}'
            feedin_battery_min_soc: '{{min_soc}}'
            selfuse_charge_battery_from_grid: '{{ states(''input_number.solax_default_charge_to_limit_soc'')
              }}'
            feedin_charge_battery_from_grid: '{{ states(''input_number.solax_default_charge_to_limit_soc'')
              }}'
      alias: Set Charge Battery Settings - Stop
    - conditions:
      - condition: trigger
        id:
        - Discharge
      - condition: state
        entity_id: input_boolean.battery_discharge_now
        state: 'on'
      sequence:
      - action: script.solax_set_mode_and_settings
        data:
          mode: 3
          manual_mode: 2
      alias: Discharge Start
    - conditions:
      - condition: trigger
        id:
        - Finished discharge
      - condition: template
        value_template: "{{(state_attr('sensor.solax_local_settings', 'Data')[10]
          != default_mode) \nor (state_attr('sensor.solax_local_settings', 'Data')[0]
          != min_soc) \nor (state_attr('sensor.solax_local_settings', 'Data')[12]
          != min_soc)}}\n"
      sequence:
      - action: script.solax_set_mode_and_settings
        data:
          mode: '{{default_mode}}'
          settings:
            selfuse_battery_min_soc: '{{min_soc}}'
            feedin_battery_min_soc: '{{min_soc}}'
      alias: Discharge Finished
    - conditions:
      - condition: trigger
        id:
        - Henley Block - Battery Usage Options
      - condition: template
        value_template: "{{ ((state_attr('sensor.solax_local_settings', 'Data')[0]
          != min_soc) \nor (state_attr('sensor.solax_local_settings', 'Data')[12]
          != min_soc))\nor (state_attr('sensor.solax_local_settings', 'Data')[10]
          != 3)}}"
      sequence:
      - action: script.solax_set_mode_and_settings
        data:
          mode: '{{default_mode}}'
          settings:
            selfuse_battery_min_soc: '{{min_soc}}'
            feedin_battery_min_soc: '{{min_soc}}'
      alias: Henley Block
    - conditions:
      - condition: trigger
        id:
        - Charge Period 2 End
      - condition: template
        value_template: "{{((state_attr('sensor.solax_local_settings', 'Data')[10]
          != default_mode) \nor (state_attr('sensor.solax_local_settings', 'Data')[0]
          != min_soc) \nor (state_attr('sensor.solax_local_settings', 'Data')[12]
          != min_soc))\nand states('sensor.solax_local_battery_chd2_enabled')|bool==true}}\n"
      - condition: state
        entity_id: binary_sensor.free_electricity_today
        state:
        - 'off'
      sequence:
      - action: script.solax_set_mode_and_settings
        data:
          mode: '{{default_mode}}'
          settings:
            selfuse_battery_min_soc: '{{min_soc}}'
            feedin_battery_min_soc: '{{min_soc}}'
            period2_enabled: '{{ 0 }}'
      alias: Charge Period 2 - End
    - conditions:
      - condition: trigger
        id:
        - Inverter shouldn't be left in this mode
      - condition: template
        value_template: '{{(state_attr(''sensor.solax_local_settings'', ''Data'')[10]
          == 3)

          }}

          '
        enabled: false
      sequence:
      - action: script.solax_set_mode_and_settings
        data:
          mode: '{{default_mode}}'
          settings:
            selfuse_battery_min_soc: '{{min_soc}}'
            feedin_battery_min_soc: '{{min_soc}}'
      alias: Inverter Stuck Catcher
    - conditions:
      - condition: trigger
        id:
        - Free Electric Prepare
      - condition: state
        entity_id: input_boolean.free_electric
        state: 'on'
      - condition: not
        conditions:
        - condition: template
          value_template: "{% set start_time =\n    as_datetime(state_attr('input_datetime.octopus_free_electricity_start',\n
            \   'timestamp') - 60) \n%}\n\n{% set end_time =\n    as_datetime(state_attr('input_datetime.octopus_free_electricity_stop',\n
            \   'timestamp') - 0) \n%}\n\n\n{{ (state_attr('sensor.solax_local_settings',
            'Data')[10] == default_mode \nand state_attr('sensor.solax_local_settings',
            'Data')[7] == 1 \nand state_attr('sensor.solax_local_settings', 'Data')[8]
            == start_time.hour + start_time.minute * 256 \nand state_attr('sensor.solax_local_settings',
            'Data')[9] == end_time.hour + end_time.minute * 256) \n}}"
      sequence:
      - action: script.solax_set_mode_and_settings
        data:
          mode: '{{1}}'
          settings:
            forced_charge_start2: '{% set start_time = as_datetime(state_attr(''input_datetime.octopus_free_electricity_start'',
              ''timestamp'') - 0)|as_local %}{{ start_time.hour + start_time.minute
              * 256 }}'
            forced_charge_end2: '{% set end_time = as_datetime(state_attr(''input_datetime.octopus_free_electricity_stop'',
              ''timestamp'') - 0)|as_local %}{{ end_time.hour + end_time.minute *
              256 }}'
            period2_enabled: '{{1}}'
      alias: Free Electric Prep
    - conditions:
      - condition: trigger
        id:
        - Free Electric End - Stop EV Charging
      sequence:
      - action: script.safe_switch_toggle
        metadata: {}
        data:
          target_switch: switch.octopus_intelligent_smart_charge
          desired_state: 'off'
          max_retries: 4
          backoff: 5
      - action: script.solax_set_mode_and_settings
        data:
          mode: '{{states(''sensor.solax_default_operation_mode'')|int}}'
          settings:
            period2_enabled: '{{0}}'
            selfuse_charge_battery_from_grid: '{{states(''input_number.solax_default_charge_to_limit_soc'')|int}}'
            feedin_charge_battery_from_grid: '{{states(''input_number.solax_default_charge_to_limit_soc'')|int}}'
            feedin_battery_min_soc: '{{states(''input_number.solax_default_discharge_limit_soc'')|int}}'
            selfuse_battery_min_soc: '{{states(''input_number.solax_default_discharge_limit_soc'')|int}}'
      - if:
        - condition: state
          entity_id: input_boolean.zappi_eco_always
          state: 'on'
        then:
        - action: select.select_option
          metadata: {}
          data:
            option: Eco+
          target:
            entity_id: select.zappi_charge_mode
        else:
        - action: select.select_option
          metadata: {}
          data:
            option: Stopped
          target:
            entity_id: select.zappi_charge_mode
      alias: Free Electric End Charging
    - conditions:
      - condition: trigger
        id:
        - Check Settings
      sequence:
      - action: script.solax_set_mode_and_settings
        data:
          mode: '{{default_mode}}'
          settings:
            selfuse_battery_min_soc: '{{min_soc}}'
            feedin_battery_min_soc: '{{min_soc}}'
      - event: Solax Zappi Octopus Control
        event_data:
          message: Attempted recovery @ {{now().strftime('%H:%M')}}.
          title: Check Settings
          class: high
        enabled: true
    - conditions:
      - condition: trigger
        id:
        - Submit Settings
      sequence:
      - action: script.solax_set_mode_and_settings
        data:
          mode: '{{ state_attr(''input_select.solax_work_mode'',''options'').index(states(''input_select.solax_work_mode''))
            }}'
          manual_mode: '{{ state_attr(''input_select.solax_manual_modes'',''options'').index(states(''input_select.solax_manual_modes''))
            }}'
          settings:
            feedin_battery_min_soc: '{{ states(''input_number.solax_feed_in_battery_min_soc'')
              }}'
            selfuse_battery_min_soc: '{{ states(''input_number.solax_selfuse_battery_min_soc'')
              }}'
            feedin_charge_battery_from_grid: '{{ states(''input_number.solax_feed_in_charge_to_soc'')
              }}'
            selfuse_charge_battery_from_grid: '{{ states(''input_number.solax_selfuse_charge_to_soc'')
              }}'
            forced_charge_start: '{{(as_datetime(state_attr(''input_datetime.solax_battery_start_charge_time'',''timestamp'')).hour
              * 1) + (as_datetime(state_attr(''input_datetime.solax_battery_start_charge_time'',
              ''timestamp'')).minute * 256) }}'
            forced_charge_end: '{{(as_datetime(state_attr(''input_datetime.solax_battery_stop_charge_time'',''timestamp'')).hour
              * 1) + (as_datetime(state_attr(''input_datetime.solax_battery_stop_charge_time'',
              ''timestamp'')).minute * 256) }}'
            allowed_discharge_start: '{{(as_datetime(state_attr(''input_datetime.solax_battery_start_discharge_time'',''timestamp'')).hour
              * 1) + (as_datetime(state_attr(''input_datetime.solax_battery_start_discharge_time'',
              ''timestamp'')).minute * 256) }}'
            allowed_discharge_end: '{{(as_datetime(state_attr(''input_datetime.solax_battery_stop_discharge_time'',''timestamp'')).hour
              * 1) + (as_datetime(state_attr(''input_datetime.solax_battery_stop_discharge_time'',
              ''timestamp'')).minute * 256) }}'
            selfuse_charge_from_grid_enable: '{{ 1 if is_state(''input_boolean.self_use_enable_charge_from_grid'',''on'')
              else 0 }}'
            forced_charge_start2: '{{ (as_datetime(state_attr(''input_datetime.solax_start_charge_2'',''timestamp'')).hour)
              + (as_datetime(state_attr(''input_datetime.solax_start_charge_2'', ''timestamp'')).minute
              * 256) }}'
            forced_charge_end2: '{{ (as_datetime(state_attr(''input_datetime.solax_stop_charge_2'',''timestamp'')).hour)
              + (as_datetime(state_attr(''input_datetime.solax_stop_charge_2'', ''timestamp'')).minute
              * 256) }}'
            period2_enabled: '{{ 1 if is_state(''input_boolean.solaxchargeperiod2'',''on'')
              else 0 }}'
            system_state: '{{ 1 if is_state(''input_boolean.solax_system_enable'',''on'')
              else 0 }}'
    enabled: true
  - action: input_boolean.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: input_boolean.solax_automation_running
  mode: queued
  trace:
    stored_traces: 20
  max: 4
- id: '5004'
  alias: 5004 - Solax Reload Settings
  description: "Populate UI with Solax Settings \n\n# AUTOMATION 5004\n 1. This is
    5004 only. You also need 5000 5001 and 5005. \n 2. Paste into your automations.yaml\n\n#
    Change log\nv7.2.0 disabled links to 5003\nv6.0.0 added a check to see if settings
    need refresh from inverter\n"
  triggers:
  - trigger: time_pattern
    minutes: /6
  - trigger: state
    entity_id:
    - input_boolean.solax_automation_running
    from: 'on'
    to: 'off'
    enabled: true
    for:
      hours: 0
      minutes: 0
      seconds: 13
  - entity_id:
    - input_button.refresh
    trigger: state
  conditions:
  - condition: state
    entity_id: input_boolean.solax_automation_running
    state: 'off'
  actions:
  - variables:
      mode_delay: 15
      settings_delay: 10
      refresh_settings_delay: 10
  - action: automation.turn_off
    metadata: {}
    data:
      stop_actions: true
    target:
      entity_id: automation.solax_set_ui_options
    enabled: false
  - delay:
      hours: 0
      minutes: 0
      seconds: 1
      milliseconds: 0
  - if:
    - condition: template
      value_template: '{{now()|as_timestamp-state_attr(''sensor.solax_local_settings'',''last_valid_update'')|as_timestamp
        > 5*60}}'
    then:
    - action: homeassistant.update_entity
      data:
        entity_id:
        - sensor.solax_rest_local_settings
    - delay:
        hours: 0
        minutes: 0
        seconds: '{{refresh_settings_delay}}'
  - metadata: {}
    data:
      option: '{{states(''sensor.solax_local_inverter_mode'')}}'
    target:
      entity_id: input_select.solax_work_mode
    action: input_select.select_option
  - metadata: {}
    data:
      option: '{{states(''sensor.solax_local_manual_mode_behaviour'')}}'
    target:
      entity_id: input_select.solax_manual_modes
    action: input_select.select_option
  - metadata: {}
    data:
      value: '{{states(''sensor.solax_local_feed_in_battery_min_soc'')|int}}'
    target:
      entity_id: input_number.solax_feed_in_battery_min_soc
    action: input_number.set_value
  - metadata: {}
    data:
      value: '{{states(''sensor.solax_local_feed_in_battery_charge_from_grid_to'')|int}}'
    target:
      entity_id: input_number.solax_feed_in_charge_to_soc
    action: input_number.set_value
  - metadata: {}
    data:
      value: '{{states(''sensor.solax_local_selfuse_battery_chrg_frm_grd_to'')|int}}'
    target:
      entity_id: input_number.solax_selfuse_charge_to_soc
    action: input_number.set_value
    enabled: true
  - metadata: {}
    data:
      value: '{{states(''sensor.solax_local_selfuse_battery_min_soc'')|int}}'
    target:
      entity_id: input_number.solax_selfuse_battery_min_soc
    action: input_number.set_value
    enabled: true
  - if:
    - condition: template
      value_template: '{{states(''sensor.solax_local_battery_chd2_enabled'')|bool==true}}'
    then:
    - action: input_boolean.turn_on
      target:
        entity_id: input_boolean.solaxchargeperiod2
      data: {}
  - if:
    - condition: template
      value_template: '{{states(''sensor.solax_local_battery_chd2_enabled'')|bool==false}}'
    then:
    - action: input_boolean.turn_off
      target:
        entity_id:
        - input_boolean.solaxchargeperiod2
      data: {}
  - if:
    - condition: state
      entity_id: sensor.solax_local_self_use_battery_charge_from_grid
      state: '1'
    then:
    - action: input_boolean.turn_on
      target:
        entity_id: input_boolean.self_use_enable_charge_from_grid
      data: {}
  - if:
    - condition: state
      entity_id: sensor.solax_local_self_use_battery_charge_from_grid
      state: '0'
    then:
    - action: input_boolean.turn_off
      target:
        entity_id:
        - input_boolean.self_use_enable_charge_from_grid
      data: {}
  - action: input_datetime.set_datetime
    metadata: {}
    data:
      time: '{{states(''sensor.solax_local_battery_setting_start_charge'')}}'
    target:
      entity_id: input_datetime.solax_battery_start_charge_time
  - action: input_datetime.set_datetime
    metadata: {}
    data:
      time: '{{states(''sensor.solax_local_battery_setting_stop_charge'')}}'
    target:
      entity_id: input_datetime.solax_battery_stop_charge_time
  - action: input_datetime.set_datetime
    metadata: {}
    data:
      time: '{{states(''sensor.solax_local_battery_setting_start_discharge'')}}'
    target:
      entity_id: input_datetime.solax_battery_start_discharge_time
  - action: input_datetime.set_datetime
    metadata: {}
    data:
      time: '{{states(''sensor.solax_local_battery_setting_stop_discharge'')}}'
    target:
      entity_id: input_datetime.solax_battery_stop_discharge_time
  - action: input_datetime.set_datetime
    metadata: {}
    data:
      time: '{{states(''sensor.solax_local_battery_setting_start_charge_2'')}}'
    target:
      entity_id: input_datetime.solax_start_charge_2
  - action: input_datetime.set_datetime
    metadata: {}
    data:
      time: '{{states(''sensor.solax_local_battery_setting_stop_charge_2'')}}'
    target:
      entity_id: input_datetime.solax_stop_charge_2
  - if:
    - condition: state
      entity_id: sensor.solax_local_battery_heat_enabled
      state: 'True'
    then:
    - action: input_boolean.turn_on
      target:
        entity_id: input_boolean.battery_heat_enable
      data: {}
    else:
    - action: input_boolean.turn_off
      target:
        entity_id:
        - input_boolean.battery_heat_enable
      data: {}
  - action: input_datetime.set_datetime
    metadata: {}
    data:
      time: '{{states(''sensor.solax_local_battery_heat_start'')}}'
    target:
      entity_id: input_datetime.solax_battery_start_heat_time
  - action: input_datetime.set_datetime
    metadata: {}
    data:
      time: '{{states(''sensor.solax_local_battery_heat_stop'')}}'
    target:
      entity_id: input_datetime.solax_battery_stop_heat_time
  - action: input_datetime.set_datetime
    metadata: {}
    data:
      time: '{{states(''sensor.solax_local_battery_heat_start_2'')}}'
    target:
      entity_id: input_datetime.solax_start_heat_2
  - action: input_datetime.set_datetime
    metadata: {}
    data:
      time: '{{states(''sensor.solax_local_battery_heat_stop_2'')}}'
    target:
      entity_id: input_datetime.solax_stop_heat_2
  - if:
    - condition: state
      entity_id: sensor.solax_local_system_state
      state: 'True'
    then:
    - action: input_boolean.turn_on
      target:
        entity_id:
        - input_boolean.solax_system_enable
      data: {}
  - if:
    - condition: state
      entity_id: sensor.solax_local_system_state
      state: 'False'
    then:
    - action: input_boolean.turn_off
      target:
        entity_id:
        - input_boolean.solax_system_enable
      data: {}
  - metadata: {}
    data:
      option: '{{states(''sensor.solax_local_battery_heat_level'')}}'
    target:
      entity_id: input_select.solax_battery_heat_level
    action: input_select.select_option
  - delay:
      hours: 0
      minutes: 0
      seconds: 1
      milliseconds: 0
  - action: automation.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: automation.solax_set_ui_options
    enabled: false
  trace:
    stored_traces: 20
  mode: single
- id: '5005'
  alias: 5005 - Solax Zappi Octopus Control - Notifier
  description: '# 5005 - Solax Zappi Octopus Control - Notifier

    Allows for notification of activity such as EV Connected, EV charging started,
    amount Octopus will dispatch, Solax battery forced discharge events etc


    # Initial installation instructions

    1. Copy to your automations.yaml and reload yaml from developer tools


    # Change Log

    v4.0 Added logging

    v3.1 Better notification management

    v2.2 Added Alert Exclusions

    v2.1.4 Renamed automation

    v2.1.3 Simplications

    v2.0 Initial production release

    v1.0 Initial'
  triggers:
  - trigger: event
    event_type: Solax Zappi Octopus Control
    event_data:
      class: normal
    id: Normal
  - trigger: event
    event_type: Solax Zappi Octopus Control
    event_data:
      class: high
    id: High
  - trigger: event
    event_type: Solax Control
    event_data:
      class: normal
    id: Normal
  - trigger: event
    event_type: Solax Control
    event_data:
      class: high
    id: High
  conditions: []
  actions:
  - action: logbook.log
    data:
      name: Solax Zappi Octopus
      message: 'Event ({{ trigger.event.data.class }}): {{ trigger.event.data.title
        }}

        '
  - choose:
    - conditions:
      - condition: trigger
        id:
        - High
      - condition: or
        conditions:
        - condition: state
          entity_id: input_boolean.solax_zappi_octopus_control_notifications
          state: 'off'
        - condition: state
          entity_id: input_boolean.nofify_mobile
          state: 'off'
      sequence:
      - action: persistent_notification.create
        data:
          title: '{{trigger.event.data.title}}'
          message: '{{trigger.event.data.message}}'
      - if:
        - condition: template
          value_template: '{{states(''input_text.mobile_device_selected'') != ''None
            Selected''}}'
        then:
        - repeat:
            for_each: '{{state_attr(''sensor.solax_zappi_octopus_devices_to_notify'',
              ''mobile_devices'') | map(attribute=''device'') | reject(''match'',"
              ")|list}}

              '
            sequence:
            - action: notify.{{repeat.item}}
              metadata: {}
              data:
                title: '{{trigger.event.data.title}}'
                message: '{{trigger.event.data.message}}'
    - conditions:
      - condition: or
        conditions:
        - condition: trigger
          id:
          - Normal
        - condition: trigger
          id:
          - High
      - condition: state
        entity_id: input_boolean.solax_zappi_octopus_control_notifications
        state: 'on'
      sequence:
      - if:
        - condition: template
          value_template: '{{trigger.event.data.title not in state_attr(''sensor.solax_zappi_octopus_notification_to_exclude'',''notification_list'')
            | map(attribute=''notification'') | list}}'
        then:
        - action: persistent_notification.create
          data:
            title: '{{trigger.event.data.title}}'
            message: '{{trigger.event.data.message}}'
        - if:
          - condition: template
            value_template: '{{states(''input_text.mobile_device_selected'') != ''None
              Selected''}}'
          then:
          - repeat:
              for_each: '{{state_attr(''sensor.solax_zappi_octopus_devices_to_notify'',
                ''mobile_devices'') | map(attribute=''device'') | reject(''match'',"
                ")|list}}

                '
              sequence:
              - action: notify.{{repeat.item}}
                metadata: {}
                data:
                  title: '{{trigger.event.data.title}}'
                  message: '{{trigger.event.data.message}}'
  mode: queued
  max: 10
