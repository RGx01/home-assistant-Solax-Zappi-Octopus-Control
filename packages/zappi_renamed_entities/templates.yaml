###############################################
# replace zappi serial number zappi_XXXXXXXX
# V5.0 Refactor
###############################################
zappi_renamed_entities_templates:
  template:
    ######################################################
    # Zappi plug status avoiding unknown when cloud response is not available
    ######################################################
    - trigger:
        - trigger: state
          entity_id: sensor.myenergi_zappi_XXXXXXXX_plug_status
          not_to:
            - unavailable
            - unknown
      sensor:
        - name: Zappi Plug Status
          unique_id: zappi_plug_status
          state: "{{states('sensor.myenergi_zappi_XXXXXXXX_plug_status')}}"
          icon: mdi:ev-plug-type2
          attributes:
            changes: >
              {% set current = this.attributes.get('changes', {}) %}
              {% set new =
                { trigger.entity_id:
                  {
                    'datetime': trigger.to_state.last_changed.isoformat(),
                    'from': trigger.from_state.state,
                    'to': trigger.to_state.state
                  }
                }
              %}
              {{ dict(current, **new) }}

    ######################################################
    # for when zappi cloud sensor dips out
    ######################################################
    - sensor:
      - name: Zappi Power CT Internal Load
        unique_id: zappi_power_ct_internal_load
        state: >
          {%if states('sensor.myenergi_zappi_XXXXXXXX_power_ct_internal_load') in ['unknown', 'unavailable','none'] %}
            {{states('sensor.zappi_power_ct_internal_load')}}
          {%else%}
            {{states('sensor.myenergi_zappi_XXXXXXXX_power_ct_internal_load')}}
          {%endif%}
        unit_of_measurement: "W"
        state_class: measurement
        device_class: "power"

    ######################################################
    # for when zappi cloud sensor dips out
    ######################################################
    - sensor:
      - name: Zappi Power CT Grid Load
        unique_id: zappi_power_ct_grid_load
        state: >
          {%if states('sensor.myenergi_zappi_XXXXXXXX_grid_ct2') in ['unknown', 'unavailable','none'] %}
            {{states('sensor.zappi_power_ct_internal_load')}}
          {%else%}
            {{states('sensor.myenergi_zappi_XXXXXXXX_grid_ct2')}}
          {%endif%}
        unit_of_measurement: "W"
        state_class: measurement
        device_class: "power"

    ######################################################
    # for when zappi cloud sensor dips out
    ######################################################
    - sensor:
      - name: Zappi Charge Added Session
        unique_id: zappi_charge_added_session
        state: >
          {%if states('sensor.myenergi_zappi_XXXXXXXX_charge_added_session') in ['unknown', 'unavailable','none'] %}
            {{states('sensor.zappi_charge_added_session')}}
          {%else%}
            {{states('sensor.myenergi_zappi_XXXXXXXX_charge_added_session')}}
          {%endif%}
        unit_of_measurement: "kWh"
        state_class: total
        device_class: "energy"

    ######################################################
    # normalised to remove account number in automations
    ######################################################
    - select:
        - name: Zappi Charge Mode
          unique_id: zappi_charge_mode
          icon: mdi:ev-station
          state: "{{ states('select.myenergi_zappi_XXXXXXXX_charge_mode') }}"
          options: >
            {{ state_attr('select.myenergi_zappi_XXXXXXXX_charge_mode', 'options') }}
          select_option:
            - service: select.select_option
              target:
                entity_id: select.myenergi_zappi_XXXXXXXX_charge_mode
              data:
                option: "{{ option }}"

    ######################################################
    # normalised to remove account number in automations
    ######################################################
    - number:
        - name: "Zappi Minimum Green Level"
          unique_id: zappi_minimum_green_level
          state: "{{ states('number.myenergi_zappi_XXXXXXXX_minimum_green_level') | float }}"
          icon: mdi:leaf
          min: 0
          max: 100
          step: 1
          set_value:
            - service: number.set_value
              target:
                entity_id: number.myenergi_zappi_XXXXXXXX_minimum_green_level
              data:
                value: "{{ value }}"